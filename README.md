# LinkLab 2024ï¼šæ„å»ºä½ è‡ªå·±çš„é“¾æ¥å™¨

```
 ___       ___  ________   ___  __    ___       ________  ________
|\  \     |\  \|\   ___  \|\  \|\  \ |\  \     |\   __  \|\   __  \
\ \  \    \ \  \ \  \\ \  \ \  \/  /|\ \  \    \ \  \|\  \ \  \|\ /_
 \ \  \    \ \  \ \  \\ \  \ \   ___  \ \  \    \ \   __  \ \   __  \
  \ \  \____\ \  \ \  \\ \  \ \  \\ \  \ \  \____\ \  \ \  \ \  \|\  \
   \ \_______\ \__\ \__\\ \__\ \__\\ \__\ \_______\ \__\ \__\ \_______\
    \|_______|\|__|\|__| \|__|\|__| \|__|\|_______|\|__|\|__|\|_______|
```

> æ¯ä¸ªç¨‹åºå‘˜éƒ½ç”¨è¿‡é“¾æ¥å™¨ï¼Œä½†å¾ˆå°‘æœ‰äººçœŸæ­£ç†è§£å®ƒã€‚
>
> åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œä½ å°†äº²æ‰‹å®ç°ä¸€ä¸ªé“¾æ¥å™¨ï¼Œæ­å¼€ç¨‹åºæ˜¯å¦‚ä½•è¢«"æ‹¼æ¥"åœ¨ä¸€èµ·çš„ç§˜å¯†ã€‚æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå‹å¥½çš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆFLEï¼‰ï¼Œè®©ä½ å¯ä»¥ä¸“æ³¨äºç†è§£é“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µã€‚

> [!WARNING]
> è¿™æ˜¯ LinkLab çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¦‚æœä½ ï¼š
>
> - å‘ç°äº† bugï¼Œè¯·[æäº¤ issue](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)ï¼ˆè®°å¾—éµå¾ª issue æ¨¡æ¿ï¼‰
> - æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·åœ¨[è®¨è®ºåŒº](https://github.com/RUCICS/LinkLab-2024-Assignment/discussions)æå‡º
> - æƒ³è¦æ”¹è¿›å®éªŒï¼Œæ¬¢è¿æäº¤ PR
>
> é¢„è®¡è€—æ—¶ï¼š
>
> - åŸºç¡€ä»»åŠ¡ï¼š10-15 å°æ—¶
> - è¿›é˜¶å†…å®¹ï¼š5-10 å°æ—¶
>
> æˆ‘ä»¬ä¼šè®¤çœŸå¯¹å¾…æ¯ä¸€ä¸ªåé¦ˆï¼

[![GitHub Issues](https://img.shields.io/github/issues/RUCICS/LinkLab-2024-Assignment?style=for-the-badge&logo=github)](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)

## ç¯å¢ƒè¦æ±‚

- æ“ä½œç³»ç»Ÿï¼šLinuxï¼ˆæ¨è Ubuntu 22.04 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
  - Windows ç”¨æˆ·å¯è€ƒè™‘ä½¿ç”¨ WSL 2
- ç¼–è¯‘å™¨ï¼šg++ 12.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆéœ€è¦ C++20ï¼‰
- Python 3.6+
- Makefile
- Git

è¯·ä½¿ç”¨ Git ç®¡ç†ä½ çš„ä»£ç ï¼Œå…»æˆç»å¸¸æäº¤çš„å¥½ä¹ æƒ¯ã€‚

## å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/RUCICS/LinkLab-2024.git
cd LinkLab-2024

# æ„å»ºé¡¹ç›®
make

# è¿è¡Œæµ‹è¯•ï¼ˆæ­¤æ—¶åº”è¯¥ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
make test_1  # è¿è¡Œä»»åŠ¡ä¸€çš„æµ‹è¯•
make test    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

## é¡¹ç›®ç»“æ„

```
LinkLab-2024/
â”œâ”€â”€ include/                    # å¤´æ–‡ä»¶
â”‚   â””â”€â”€ fle.hpp                # FLE æ ¼å¼å®šä¹‰ï¼ˆè¯·ä»”ç»†é˜…è¯»ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ base/                  # åŸºç¡€æ¡†æ¶ï¼ˆåŠ©æ•™æä¾›ï¼‰
â”‚   â”‚   â”œâ”€â”€ cc.cpp            # ç¼–è¯‘å™¨å‰ç«¯ï¼Œç”Ÿæˆ FLE æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ exec.cpp          # ç¨‹åºåŠ è½½å™¨ï¼Œè¿è¡Œç”Ÿæˆçš„ç¨‹åº
â”‚   â””â”€â”€ student/              # ä½ éœ€è¦å®Œæˆçš„ä»£ç 
â”‚       â”œâ”€â”€ nm.cpp            # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æŸ¥çœ‹å™¨
â”‚       â””â”€â”€ ld.cpp            # ä»»åŠ¡äºŒ~å…­ï¼šé“¾æ¥å™¨ä¸»ç¨‹åº
â””â”€â”€ tests/                    # æµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ cases/               # æŒ‰ä»»åŠ¡åˆ†ç±»çš„æµ‹è¯•
        â”œâ”€â”€ 1-nm-test/      # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æ˜¾ç¤º
        â”œâ”€â”€ 2-ld-test/      # ä»»åŠ¡äºŒï¼šåŸºç¡€é“¾æ¥
        â””â”€â”€ ...             # æ›´å¤šæµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ common/              # æµ‹è¯•ç”¨ä¾‹çš„å…¬å…±åº“
        â””â”€â”€ minilibc.c       # è¿·ä½  libc çš„å®ç°
```

æ¯ä¸ªä»»åŠ¡éƒ½é…æœ‰å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬ï¼š

- æºä»£ç ï¼šç”¨äºç”Ÿæˆæµ‹è¯•è¾“å…¥
- æœŸæœ›è¾“å‡ºï¼šç”¨äºéªŒè¯ä½ çš„å®ç°
- é…ç½®æ–‡ä»¶ï¼šå®šä¹‰æµ‹è¯•å‚æ•°

ä½ å¯ä»¥ï¼š

1. é˜…è¯»æµ‹è¯•ä»£ç äº†è§£å…·ä½“è¦æ±‚
2. è¿è¡Œæµ‹è¯•æ£€æŸ¥å®ç°æ˜¯å¦æ­£ç¡®
3. ä¿®æ”¹æµ‹è¯•æ¢ç´¢æ›´å¤šå¯èƒ½æ€§

## ä»»åŠ¡é›¶ï¼šç†è§£ç›®æ ‡æ–‡ä»¶æ ¼å¼

åœ¨å¼€å§‹å†™é“¾æ¥å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£å®ƒå¤„ç†çš„æ–‡ä»¶æ ¼å¼ã€‚ä¼ ç»Ÿçš„ ELF æ ¼å¼è™½ç„¶å¼ºå¤§ï¼Œä½†ç»†èŠ‚å¤ªå¤šã€‚ä¸ºäº†è®©ä½ ä¸“æ³¨äºé“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬è®¾è®¡äº† FLE (Friendly Linking Executable) æ ¼å¼ã€‚

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥äº†è§£å®ƒï¼š

```c
// test.c
int message[2] = {1, 2};  // å…¨å±€æ•°ç»„

static int helper(int x) { // é™æ€å‡½æ•°
    return x + message[0];
}

int main() {             // ç¨‹åºå…¥å£
    return helper(42);
}
```

é€šè¿‡ `./cc test.c -o test.o`ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ª FLE æ–‡ä»¶ï¼š

```json5
{
    "type": ".obj", // è¿™æ˜¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶
    "shdrs": [
        // å„ä¸ªæ®µçš„å…ƒæ•°æ®
        {
            "name": ".text", // æ®µå
            "type": 1, // æ®µç±»å‹
            "flags": 1, // æ®µæƒé™
            "addr": 0, // æ®µåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
            "offset": 0, // æ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
            "size": 36  // æ®µçš„å¤§å°
        },
        {
            "name": ".data",
            "type": 1,
            "flags": 1,
            "addr": 0,
            "offset": 0,
            "size": 8
        },
        {
            "name": ".bss",
            "type": 8,
            "flags": 9,
            "addr": 0,
            "offset": 0,
            "size": 0
        }
    ],
    ".text": [
        "ğŸ·ï¸: helper 20 0", // å±€éƒ¨ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 89 7d fc 8b 15", // æœºå™¨ç 
        "â“: .rel(message - 4)", // éœ€è¦é‡å®šä½
        "ğŸ”¢: 8b 45 fc 01 d0 5d c3", // æœºå™¨ç 
        "ğŸ“¤: main 16 20", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 bf 2a 00 00 00 e8 de ff ff ff 5d c3" // æœºå™¨ç 
    ],
    ".data": [
        "ğŸ“¤: message 8 0", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 01 00 00 00 02 00 00 00" // æ•°æ®
    ],
    ".bss": []
}
```

FLE ä½¿ç”¨è¡¨æƒ…ç¬¦å·æ¥æ ‡è®°ä¸åŒç±»å‹çš„ä¿¡æ¯ï¼š

1. æœºå™¨ç ï¼šåå…­è¿›åˆ¶è¡¨ç¤º
  - ğŸ”¢ åŸå§‹çš„æœºå™¨ç æˆ–æ•°æ®
2. ç¬¦å·ï¼š`ç±»å‹: ç¬¦å·å å¤§å° æ®µå†…åç§»`
  - ğŸ·ï¸ æ–‡ä»¶å†…éƒ¨çš„å±€éƒ¨ç¬¦å·
  - ğŸ“¤ å¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„å…¨å±€ç¬¦å·
  - ğŸ“ å¯ä»¥è¢«è¦†ç›–çš„å¼±ç¬¦å·
3. é‡å®šä½ï¼š`â“: é‡å®šä½ç±»å‹(ç›®æ ‡ç¬¦å·å [+/-] åç§»é‡)`
  - â“ éœ€è¦é‡å®šä½çš„åœ°æ–¹

è¿™äº›ä¿¡æ¯åœ¨å†…å­˜ä¸­ç”¨ C++ ç»“æ„ä½“è¡¨ç¤ºï¼ˆå®šä¹‰åœ¨ `include/fle.hpp` ä¸­ï¼‰ï¼š

```cpp
struct FLEObject {
    std::string type;                           // æ–‡ä»¶ç±»å‹
    std::map<std::string, FLESection> sections; // å„ä¸ªæ®µ
    std::vector<Symbol> symbols;                // ç¬¦å·è¡¨
    std::vector<ProgramHeader> phdrs;           // ç¨‹åºå¤´
    std::vector<SectionHeader> shdrs;           // æ®µå¤´
    size_t entry = 0;                           // å…¥å£ç‚¹
};
```

æ³¨æ„ï¼ŒFLE æ–‡ä»¶çš„æ ¼å¼å’Œå†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œè™½ç„¶å¤§éƒ¨åˆ†å†…å®¹æ˜¯å¯¹åº”çš„ï¼Œä½†å…¶ä¸­æ•°æ®æ®µçš„è¡¨ç¤ºæ˜¯ä¸åŒçš„ï¼š

1. é‡å®šä½å’Œç¬¦å·å®šä¹‰æ˜¯å†…è”çš„ï¼ˆæ¯”å¦‚ï¼Œç¬¦å·å®šä¹‰çš„åœ°æ–¹ç›´æ¥ç”¨ ğŸ“¤ æ ‡è®°ï¼Œè€Œä¸æ˜¯åˆ†ç¦»çš„ç¬¦å·è¡¨ï¼‰
2. æ²¡æœ‰å ä½å­—èŠ‚ï¼ˆéœ€è¦é‡å®šä½çš„åœ°æ–¹ç›´æ¥ç”¨ â“ æ ‡è®°ï¼Œè€Œä¸æ˜¯ç”¨ 0 å ä½ï¼‰

æ®µå¤´ï¼ˆsection headersï¼‰æ˜¯ç›®æ ‡æ–‡ä»¶ä¸­çš„é‡è¦å…ƒæ•°æ®ï¼Œå®ƒæè¿°äº†æ¯ä¸ªæ®µçš„å±æ€§å’Œä½ç½®ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œæ¯ä¸ªæ®µå¤´åŒ…å«ï¼š

- `name`ï¼šæ®µçš„åç§°ï¼ˆå¦‚ `.text`ã€`.data` ç­‰ï¼‰
- `type`ï¼šæ®µçš„ç±»å‹ï¼ˆå¦‚ä»£ç ã€æ•°æ®ç­‰ï¼‰
- `flags`ï¼šæ®µçš„æƒé™æ ‡å¿—ï¼ˆå¦‚å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰
- `addr`ï¼šæ®µåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
- `offset`ï¼šæ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
- `size`ï¼šæ®µçš„å¤§å°

è¿™äº›ä¿¡æ¯å¯¹é“¾æ¥å™¨æ¥è¯´éå¸¸é‡è¦ â€”â€” å®ƒä»¬ä¸ä»…å‘Šè¯‰é“¾æ¥å™¨æ¯ä¸ªæ®µçš„ä½ç½®å’Œå¤§å°ï¼Œè¿˜æŒ‡ç¤ºäº†æ®µçš„æ€§è´¨å’Œè®¿é—®æƒé™ã€‚åœ¨åé¢çš„ä»»åŠ¡ä¸­ï¼Œä½ ä¼šé€æ­¥ç†è§£å¦‚ä½•åˆ©ç”¨è¿™äº›ä¿¡æ¯æ¥æ­£ç¡®åœ°ç»„ç»‡ç¨‹åºçš„å†…å­˜å¸ƒå±€ã€‚

åœ¨æ¥ä¸‹æ¥çš„ä»»åŠ¡ä¸­ï¼Œä½ å°†é€æ­¥å®ç°å¤„ç†è¿™ç§æ ¼å¼çš„å·¥å…·é“¾ï¼Œä»æœ€åŸºæœ¬çš„ç¬¦å·è¡¨æŸ¥çœ‹å™¨å¼€å§‹ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªå®Œæ•´çš„é“¾æ¥å™¨ã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼

## ä»»åŠ¡ä¸€ï¼šçª¥æ¢ç¨‹åºçš„ç¬¦å·è¡¨

ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„é”™è¯¯ï¼Ÿ

```
undefined reference to `printf'
multiple definition of `main'
```

è¿™äº›éƒ½ä¸ç¬¦å·ï¼ˆsymbolï¼‰æœ‰å…³ã€‚ç¬¦å·å°±åƒç¨‹åºä¸­çš„"åå­—"ï¼Œä»£è¡¨äº†å‡½æ•°ã€å˜é‡ç­‰ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£ï¼š

```c
static int counter = 0;        // é™æ€å˜é‡ï¼šæ–‡ä»¶å†…å¯è§
int shared = 42;              // å…¨å±€å˜é‡ï¼šå…¶ä»–æ–‡ä»¶å¯è§
extern void print(int x);     // å¤–éƒ¨å‡½æ•°ï¼šéœ€è¦å…¶ä»–æ–‡ä»¶æä¾›

void count() {                // å…¨å±€å‡½æ•°
    counter++;                // è®¿é—®é™æ€å˜é‡
    print(counter);           // è°ƒç”¨å¤–éƒ¨å‡½æ•°
}
```

è¿™æ®µä»£ç ä¸­åŒ…å«äº†å‡ ç§ä¸åŒçš„ç¬¦å·ï¼š

- `counter`ï¼šé™æ€ç¬¦å·ï¼Œåªåœ¨æ–‡ä»¶å†…å¯è§
- `shared`ï¼šå…¨å±€ç¬¦å·ï¼Œå¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨
- `print`ï¼šæœªå®šä¹‰ç¬¦å·ï¼Œéœ€è¦åœ¨é“¾æ¥æ—¶æ‰¾åˆ°ï¼ˆä½†ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥æ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤„ç†ï¼‰
- `count`ï¼šå…¨å±€å‡½æ•°ç¬¦å·

ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å†™ä¸€ä¸ªå·¥å…·ï¼ˆnmï¼‰æ¥æŸ¥çœ‹è¿™äº›ç¬¦å·ã€‚å¯¹äºä¸Šé¢çš„ä»£ç ï¼Œå®ƒåº”è¯¥è¾“å‡ºï¼š

```
0000000000000000 T count    # å…¨å±€å‡½æ•°åœ¨ text æ®µ
0000000000000000 b counter  # é™æ€å˜é‡åœ¨ bss æ®µ
0000000000000000 D shared   # å…¨å±€å˜é‡åœ¨ data æ®µ
```

æ¯ä¸€è¡ŒåŒ…å«ï¼š

- åœ°å€ï¼šç¬¦å·åœ¨å…¶æ‰€åœ¨æ®µä¸­çš„åç§»é‡
- ç±»å‹ï¼šè¡¨ç¤ºç¬¦å·çš„ç±»å‹å’Œä½ç½®
  - å¤§å†™ï¼ˆTã€Dã€Bã€Rï¼‰ï¼šå…¨å±€ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - å°å†™ï¼ˆtã€dã€bã€rï¼‰ï¼šå±€éƒ¨ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - Wã€Vï¼šå¼±ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€è¿˜æ˜¯åœ¨æ•°æ®æ®µæˆ– BSS æ®µ
- åç§°ï¼šç¬¦å·çš„åå­—

è¦å®ç°è¿™ä¸ªå·¥å…·ï¼Œä½ éœ€è¦ï¼š

1. éå†ç¬¦å·è¡¨
2. ç¡®å®šæ¯ä¸ªç¬¦å·çš„ç±»å‹
3. æŒ‰æ ¼å¼æ‰“å°ä¿¡æ¯

æç¤ºï¼š

- ä½¿ç”¨ `std::setw` å’Œ `std::setfill` æ ¼å¼åŒ–è¾“å‡º
- æ ¹æ® section å­—æ®µåˆ¤æ–­ç¬¦å·ä½ç½®
- æœªå®šä¹‰ç¬¦å·çš„ section ä¸ºç©º

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_1
```

## ä»»åŠ¡äºŒï¼šå®ç°åŸºç¡€é“¾æ¥å™¨

è®©æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­å¼€å§‹ç†è§£é“¾æ¥å™¨çš„å·¥ä½œåŸç†ã€‚å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç¨‹åºï¼š

```c
// message.c
int magic = 42;    // ä¸€ä¸ªå…¨å±€å˜é‡

// main.c
extern int magic;  // å£°æ˜ï¼šmagic åœ¨åˆ«å¤„å®šä¹‰
int main() {
    return magic;  // éœ€è¦æ‰¾åˆ° magic çš„å®é™…ä½ç½®
}
```

ç¼–è¯‘å™¨ä¼šå°†è¿™äº›æºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œå®ƒä»¬çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```json
// message.fle
{
    "type": ".obj",
    ".text": [],
    ".data": [
        "ğŸ“¤: magic 4 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· magicï¼Œå¤§å°ä¸º4å­—èŠ‚
        "ğŸ”¢: 2a 00 00 00"   // å€¼ä¸º42ï¼ˆ0x2aï¼‰
    ]
}

// main.fle
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: main 16 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· mainï¼Œå¤§å°ä¸º16å­—èŠ‚
        "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 8b 05",  // æœºå™¨ç 
        "â“: .rel(magic - 4)",  // éœ€è¦é‡å®šä½ï¼šå¡«å…¥ magic çš„åœ°å€
        "ğŸ”¢: 5d c3"         // æœºå™¨ç 
    ]
}
```

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬é‡‡ç”¨æœ€ç®€å•çš„æ–¹æ¡ˆï¼šå°†æ‰€æœ‰å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªå« `.load` çš„æ®µä¸­ã€‚è¿™ä¸çœŸå®çš„å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ‰€ä¸åŒ â€”â€” å®é™…çš„å¯æ‰§è¡Œæ–‡ä»¶é€šå¸¸ä¼šå°†ä»£ç ï¼ˆ`.text`ï¼‰ã€æ•°æ®ï¼ˆ`.data`ï¼‰ç­‰æ”¾åœ¨ä¸åŒçš„æ®µä¸­ï¼Œå¹¶èµ‹äºˆå®ƒä»¬ä¸åŒçš„æƒé™ã€‚ä½†ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæŠŠæ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªæ®µä¸­ã€‚

é“¾æ¥å™¨éœ€è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š

é¦–å…ˆï¼Œå°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ä¸­çš„æ®µï¼ˆ`.text`ã€`.data` ç­‰ï¼‰æŒ‰é¡ºåºåˆå¹¶åˆ° `.load` æ®µä¸­ã€‚åœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®°å½•æ¯ä¸ªç¬¦å·åœ¨åˆå¹¶åçš„æ–°ä½ç½®ã€‚æ¯”å¦‚ `magic` ç¬¦å·åŸæœ¬åœ¨ `message.fle` çš„ `.data` æ®µå¼€å¤´ï¼Œåˆå¹¶åå®ƒçš„ä½ç½®éœ€è¦åŠ ä¸Šä¸€ä¸ªåç§»é‡ã€‚

æ¥ç€ï¼Œå¤„ç†æ‰€æœ‰çš„é‡å®šä½é¡¹ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`main.fle` ä¸­æœ‰ä¸€ä¸ªå¯¹ `magic` çš„å¼•ç”¨éœ€è¦é‡å®šä½ã€‚é“¾æ¥å™¨éœ€è¦æ‰¾åˆ° `magic` åœ¨åˆå¹¶åçš„ä½ç½®ï¼Œç„¶åå°†å…¶åœ°å€å¡«å…¥é‡å®šä½çš„ä½ç½®ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬åªéœ€è¦å¤„ç† `R_X86_64_32` å’Œ `R_X86_64_32S` ç±»å‹çš„é‡å®šä½ â€”â€” å®ƒä»¬éƒ½æ˜¯å°†ç¬¦å·çš„32ä½ç»å¯¹åœ°å€å¡«å…¥é‡å®šä½ä½ç½®ã€‚

æœ€åï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨ FLE æ ¼å¼ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„ `type` å­—æ®µå›ºå®šä¸º `.exe`ã€‚ç„¶åæˆ‘ä»¬éœ€è¦ç”Ÿæˆæ­£ç¡®çš„ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰ä»¥ä¾¿åŠ è½½å™¨èƒ½å¤Ÿæ­£ç¡®åœ°åŠ è½½ç¨‹åºã€‚

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬åªç”Ÿæˆä¸€ä¸ªç¨‹åºå¤´æ¥æè¿° `.load` æ®µã€‚å®ƒéœ€è¦æŒ‡å®šï¼š
- æ®µåï¼ˆnameï¼‰ï¼š`.load`
- åŠ è½½åœ°å€ï¼ˆvaddrï¼‰ï¼šæˆ‘ä»¬ä½¿ç”¨ 0x400000
- æ®µçš„å¤§å°ï¼ˆsizeï¼‰ï¼šåˆå¹¶åçš„æ€»å¤§å°
- æƒé™æ ‡å¿—ï¼ˆflagsï¼‰ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ç®€å•åœ°èµ‹äºˆ RWXï¼ˆå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰æƒé™ï¼ˆ0b111ï¼Œå³åè¿›åˆ¶çš„ 7ï¼‰

> [!TIP]
> æ³¨æ„ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰å’ŒèŠ‚å¤´ï¼ˆSection Headersï¼‰çš„åŒºåˆ«ï¼š
> - èŠ‚å¤´ï¼ˆSection Headersï¼‰æè¿°äº†æ–‡ä»¶ä¸­å„ä¸ªèŠ‚çš„å±æ€§ï¼Œä¸»è¦ç”¨äºé“¾æ¥å’Œè°ƒè¯•ã€‚
> - ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰æè¿°äº†ç¨‹åºè¿è¡Œæ—¶å¦‚ä½•å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œæ˜¯åŠ è½½ç¨‹åºï¼ˆloaderï¼‰å¿…éœ€çš„ä¿¡æ¯ã€‚
>
> åœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒèŠ‚å¤´å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†ç¨‹åºå¤´æ˜¯å¿…é¡»çš„ã€‚

æ­¤å¤–ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¿…é¡»æŒ‡å®šä¸€ä¸ªå…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºå¼€å§‹æ‰§è¡Œçš„ä½ç½®ã€‚åœ¨ x86-64 ç¨‹åºä¸­ï¼Œè¿™ä¸ªå…¥å£ç‚¹é€šå¸¸æ˜¯åä¸º `_start` çš„å‡½æ•°ã€‚é“¾æ¥å™¨éœ€è¦åœ¨åˆå¹¶åçš„ç¬¦å·è¡¨ä¸­æ‰¾åˆ° `_start` ç¬¦å·ï¼Œå¹¶å°†å…¶åœ°å€ï¼ˆåŸºåœ°å€ + ç¬¦å·åç§»ï¼‰è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ç‚¹ã€‚å¦‚æœæ‰¾ä¸åˆ° `_start` ç¬¦å·ï¼Œåº”è¯¥æŠ¥é”™ï¼Œå› ä¸ºè¿™æ„å‘³ç€ç¨‹åºç¼ºå°‘å¿…éœ€çš„å…¥å£ç‚¹ã€‚

æœ€ç»ˆå¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```json5
{
    "type": ".exe",           // è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
    "phdrs": [{               // ç¨‹åºå¤´
        "name": ".load",
        "vaddr": 0x400000,    // å›ºå®šçš„åŠ è½½åœ°å€
        "size": <æ€»å¤§å°>,      // åˆå¹¶åçš„æ€»å¤§å°
        "flags": 7            // å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œ
    }],
    ".load": [/* ... */],     // åˆå¹¶åçš„ .load æ®µå†…å®¹ï¼Œåº”è¯¥åªåŒ…å«æœºå™¨ç 
    "entry": <å…¥å£åœ°å€>        // ç¨‹åºçš„å…¥å£ç‚¹
}
```

åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå»ºè®®å…ˆå¤„ç†åªæœ‰ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç®€å•æƒ…å†µã€‚ä½ å¯ä»¥ä½¿ç”¨ `readfle` å·¥å…·æ£€æŸ¥è¾“å‡ºæ–‡ä»¶çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆæ¯”å¦‚æ®µçš„åˆå¹¶è¿‡ç¨‹ã€ç¬¦å·çš„æ–°åœ°å€ã€é‡å®šä½çš„å¤„ç†è¿‡ç¨‹ï¼‰ä¹Ÿä¼šå¯¹è°ƒè¯•å¾ˆæœ‰å¸®åŠ©ã€‚

å®Œæˆä¹‹åï¼Œä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•ä½ çš„é“¾æ¥å™¨ï¼š

```bash
make test_2
```

## ä»»åŠ¡ä¸‰ï¼šå®ç°ç›¸å¯¹é‡å®šä½

åœ¨ä»»åŠ¡äºŒä¸­ï¼Œæˆ‘ä»¬åªå¤„ç†äº†æœ€ç®€å•çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_32`ï¼‰ï¼Œç”¨äºè®¿é—®å…¨å±€å˜é‡ã€‚ä½†åœ¨å®é™…ç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„å…¶å®æ˜¯å‡½æ•°è°ƒç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```c
// lib.c
int add(int x) {    // ä¸€ä¸ªç®€å•çš„å‡½æ•°
    return x + 1;
}
---
// main.c
extern int add(int);  // å£°æ˜ï¼šadd å‡½æ•°åœ¨åˆ«å¤„å®šä¹‰
int main() {
    return add(41);   // è°ƒç”¨ add å‡½æ•°
}
```

ç¼–è¯‘å™¨ä¼šæŠŠå®ƒä»¬å˜æˆï¼š

```json
// lib.fle
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: add 19 0", // add å‡½æ•°
        "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 89 7d fc 8b 45 fc 83 c0", // æœºå™¨ç 
        "ğŸ”¢: 01 5d c3" // æœºå™¨ç 
    ],
    ... // å…¶ä»–å­—æ®µ
}
---
// main.fle
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: main 20 0",
        "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 bf 29 00 00 00 e8",
        "â“: .rel(add - 4)",
        "ğŸ”¢: 5d c3"
    ],
    ... // å…¶ä»–å­—æ®µ
}
```

æ³¨æ„é‚£ä¸ª `.rel(add - 4)` â€”â€” å®ƒåº”è¯¥è¢«å˜æˆä¸€ä¸ª 4 å­—èŠ‚çš„åœ°å€ï¼Œä¸å‰ä¸€å­—èŠ‚ `e8` ä¸€èµ·ï¼Œæ„æˆä¸€æ¡ `call` æŒ‡ä»¤ã€‚x86-64 çš„ `call` æŒ‡ä»¤ä½¿ç”¨ç›¸å¯¹å¯»å€ï¼ˆ`R_X86_64_PC32` ç±»å‹çš„é‡å®šä½ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå­˜å‚¨çš„ä¸æ˜¯ç›®æ ‡å‡½æ•°çš„ç»å¯¹åœ°å€ï¼Œè€Œæ˜¯"è¦è·³å¤šè¿œ"ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼š

1. ä»£ç å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„ä»»ä½•ä½ç½®ï¼ˆå¤©ç„¶æ”¯æŒä½ç½®æ— å…³ï¼Œè€Œä¸éœ€è¦åŠ¨æ€é“¾æ¥å™¨è¿è¡Œæ—¶ä¿®æ­£åœ°å€ï¼‰
2. è·³è½¬æŒ‡ä»¤æ›´çŸ­ï¼ˆä»£ç ä½“ç§¯åªè¦ä¸è¶…è¿‡ 4GBï¼Œå°±åªéœ€è¦ 32 ä½åç§»é‡ï¼‰

è®¡ç®—å…¬å¼æ˜¯ï¼š

```
åç§»é‡ = S + A - P
```

å…¶ä¸­:
- S (Symbol): ç›®æ ‡ç¬¦å·çš„åœ°å€
- A (Addend): é‡å®šä½é¡¹ä¸­çš„é™„åŠ å€¼
- P (Place): è¦è¢«ä¿®æ”¹çš„æ“ä½œæ•°çš„åœ°å€ï¼ˆé‡å®šä½ä½ç½®ï¼‰

æ¯”å¦‚ï¼Œå¯¹äºä¸€ä¸ªcallæŒ‡ä»¤:

- æŒ‡ä»¤åœ¨ 0x400034ï¼Œæ“ä½œæ•°åœ¨ 0x400035 (P)
- ç›®æ ‡å‡½æ•°åœ¨ 0x4000A0 (S) 
- Addend æ˜¯ -4 (A)

é‚£ä¹ˆï¼š

```
åç§»é‡ = 0x4000A0 + (-4) - 0x400035 = 0x67
```

æ‰€ä»¥ `call` æŒ‡ä»¤ä¼šå˜æˆï¼š

```asm
E8 67 00 00 00   ; call target
```

ä½ çš„ä»»åŠ¡æ˜¯å®ç°è¿™ç§é‡å®šä½ã€‚éœ€è¦ï¼š

1. è¯†åˆ« `R_X86_64_PC32` ç±»å‹çš„é‡å®šä½
2. æ­£ç¡®è®¡ç®—åç§»é‡ï¼ˆä½¿ç”¨ S + A - P å…¬å¼ï¼‰
3. å°†åç§»é‡å†™å…¥åˆ°æŒ‡ä»¤ä¸­

æç¤ºï¼š

1. `call` æŒ‡ä»¤çš„æ ¼å¼æ˜¯ `E8` åè·Ÿ 4 å­—èŠ‚åç§»é‡
2. é‡å®šä½é¡¹çš„ addend é€šå¸¸æ˜¯ -4
3. ç”¨è°ƒè¯•æ‰“å°éªŒè¯ä½ çš„è®¡ç®—

> [!TIP]
>
> P åœ¨è¿™é‡Œæ˜¯é‡å®šä½ä½ç½®çš„åœ°å€ï¼ˆå³**æ“ä½œæ•°**çš„åœ°å€ï¼‰è€Œä¸æ˜¯æŒ‡ä»¤çš„åœ°å€ã€‚å¥½åœ¨æˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¼šå¸®ä½ è®¡ç®—å‡ºå‡†ç¡®çš„é‡å®šä½ä½ç½®åœ°å€ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦è¿‡äºå…³æ³¨è¿™ä¸€ç»†èŠ‚ã€‚
>
> ä½ å¯ä»¥å‚è€ƒ [`include/fle.hpp`](./include/fle.hpp) ä¸­çš„ `Relocation` ç»“æ„ä½“ï¼Œæ¥äº†è§£é‡å®šä½æ¡ç›®çš„ç»“æ„ã€‚

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_3
```

ä» `test_3` å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åŒ…å« [`tests/common/minilibc.h`](./tests/common/minilibc.h) åº“ï¼Œè¿™ä¸ªåº“æ¨¡æ‹Ÿäº†æ ‡å‡† C åº“çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œæä¾›é¢„å®šä¹‰çš„ `_start` å‡½æ•°ï¼Œä¼šå°†æ§åˆ¶æƒäº¤ç»™ `main` å‡½æ•°ã€‚

## ä»»åŠ¡å››ï¼šå¤„ç†ç¬¦å·å†²çª

åœ¨å‰é¢çš„ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªç¬¦å·åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ã€‚ä½†å®é™…ç¼–ç¨‹ä¸­ç»å¸¸ä¼šé‡åˆ°åŒåç¬¦å·ï¼Œæ¯”å¦‚ï¼š

```c
// config.c
int debug_level = 0;  // é»˜è®¤é…ç½®
---
// main.c
int debug_level = 1;  // è‡ªå®šä¹‰é…ç½®
```

è¿™æ—¶é“¾æ¥å™¨è¯¥æ€ä¹ˆåŠï¼Ÿç”¨å“ªä¸ª `debug_level`ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC è¯­è¨€å…è®¸ç¨‹åºå‘˜æŒ‡å®šç¬¦å·çš„"å¼ºåº¦"ï¼š

- å¼ºç¬¦å·ï¼ˆGLOBALï¼‰ï¼šæ™®é€šçš„å…¨å±€ç¬¦å·
- å¼±ç¬¦å·ï¼ˆWEAKï¼‰ï¼šå¯ä»¥è¢«è¦†ç›–çš„å¤‡é€‰é¡¹

æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œç”¨å¼±ç¬¦å·æ¥æä¾›å¯è¦†ç›–çš„é»˜è®¤å®ç°ï¼š

```c
// logger.c
__attribute__((weak))        // æ ‡è®°ä¸ºå¼±ç¬¦å·
void init_logger() {         // é»˜è®¤çš„åˆå§‹åŒ–å‡½æ•°
    // ä½¿ç”¨é»˜è®¤é…ç½®
}
---
// main.c
void init_logger() {         // å¼ºç¬¦å·ä¼šè¦†ç›–é»˜è®¤å®ç°
    // ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
}
```

é“¾æ¥è§„åˆ™å¾ˆç®€å•ï¼š

1. å¼ºç¬¦å·å¿…é¡»å”¯ä¸€

   ```c
   // a.c
   int x = 1;        // å¼ºç¬¦å·
   ---
   // b.c
   int x = 2;        // é”™è¯¯ï¼šé‡å¤å®šä¹‰ï¼
   ```

2. å¼ºç¬¦å·ä¼˜å…ˆäºå¼±ç¬¦å·

   ```c
   // a.c
   __attribute__((weak)) int v = 1;  // å¼±ç¬¦å·
   ---
   // b.c
   int v = 2;                        // å¼ºç¬¦å·ï¼Œè¿™ä¸ªä¼šè¢«ä½¿ç”¨
   ```

3. å¤šä¸ªå¼±ç¬¦å·æ—¶å–ä»»æ„ä¸€ä¸ªï¼Œæˆ‘ä»¬åœ¨æ­¤é€‰æ‹©ç¬¬ä¸€ä¸ª
   ```c
   // a.c
   __attribute__((weak)) int mode = 1;  // è¿™ä¸ªä¼šè¢«ä½¿ç”¨
   ---
   // b.c
   __attribute__((weak)) int mode = 2;  // è¿™ä¸ªä¼šè¢«å¿½ç•¥
   ```

ä½ çš„ä»»åŠ¡æ˜¯å®ç°è¿™äº›è§„åˆ™ã€‚å…·ä½“æ¥è¯´ï¼š

1. æ”¶é›†æ‰€æœ‰ç¬¦å·
2. æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å¼ºç¬¦å·ï¼ˆæŠ¥é”™ï¼‰
3. åœ¨å¼ºå¼±ç¬¦å·å†²çªæ—¶é€‰æ‹©å¼ºç¬¦å·
4. åœ¨å¤šä¸ªå¼±ç¬¦å·æ—¶é€‰æ‹©ä»»æ„ä¸€ä¸ª

æç¤ºï¼š

1. ä½¿ç”¨ `std::map` æŒ‰åå­—åˆ†ç»„ç¬¦å·
2. ä»”ç»†æ£€æŸ¥æ¯ä¸ªç¬¦å·çš„ `SymbolType`
3. ä¿æŒè‰¯å¥½çš„é”™è¯¯ä¿¡æ¯

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_4
```

## ä»»åŠ¡äº”ï¼šå¤„ç† 64 ä½åœ°å€

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¤„ç†çš„éƒ½æ˜¯ 32 ä½çš„åœ°å€ï¼ˆ`R_X86_64_32` å’Œ `R_X86_64_PC32`ï¼‰ã€‚ä½†åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ã€‚æ¯”å¦‚ï¼š

```c
// ä¸€ä¸ªå…¨å±€æ•°ç»„
int numbers[] = {1, 2, 3, 4};

// ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªæ•°ç»„çš„æŒ‡é’ˆ
int *ptr = &numbers[0];  // éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ï¼
```

ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ 64 ä½åœ°å€ï¼Ÿå› ä¸ºï¼š

1. æŒ‡é’ˆæœ¬èº«æ˜¯ 64 ä½çš„ï¼ˆ8 å­—èŠ‚ï¼‰
2. ç¨‹åºå¯èƒ½è¢«åŠ è½½åˆ°é«˜åœ°å€åŒºåŸŸ
3. 32 ä½åœ°å€æœ€å¤šåªèƒ½è®¿é—® 4GB ç©ºé—´

è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼š

```json
{
    "type": ".obj",
    ".data": [
        "ğŸ“¤: numbers 16", // numbers æ•°ç»„
        "ğŸ”¢: 01 00 00 00", // 1
        "ğŸ”¢: 02 00 00 00", // 2
        "ğŸ”¢: 03 00 00 00", // 3
        "ğŸ”¢: 04 00 00 00"  // 4
    ],
    ".data.rel.local": [
        "ğŸ“¤: ptr 8",
        "â“: .abs64(numbers + 0)" // éœ€è¦ numbers çš„å®Œæ•´åœ°å€
    ]
    ...
}
```

æ³¨æ„é‚£ä¸ª `.abs64` â€”â€” è¿™æ˜¯ä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼Œå®ƒå‘Šè¯‰é“¾æ¥å™¨ï¼š"åœ¨è¿™é‡Œå¡«å…¥ç¬¦å·çš„å®Œæ•´ 64 ä½åœ°å€"ã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ”¯æŒè¿™ç§é‡å®šä½ã€‚éœ€è¦æ³¨æ„ï¼š

1. å†™å…¥å®Œæ•´çš„ 64 ä½åœ°å€ï¼ˆ8 å­—èŠ‚ï¼‰
2. è€ƒè™‘å­—èŠ‚åºï¼ˆx86 æ˜¯å°ç«¯ï¼‰
3. åœ°å€è¦åŠ ä¸ŠåŸºåœ°å€ï¼ˆ0x400000ï¼‰

æç¤ºï¼š

1. ä½¿ç”¨ 64 ä½æ•´æ•°å­˜å‚¨åœ°å€
2. å°å¿ƒæ•´æ•°æº¢å‡º
3. ç”¨ readfle æ£€æŸ¥è¾“å‡º

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_5
```

## ä»»åŠ¡å…­ï¼šåˆ†ç¦»ä»£ç å’Œæ•°æ®

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰å†…å®¹éƒ½æ”¾åœ¨ä¸€ä¸ªï¿½ï¿½ï¿½é‡Œã€‚è¿™çœ‹èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†æ­£å¦‚æˆ‘ä»¬åœ¨æ±‡ç¼–ä¸€ç« æ‰€å­¦åˆ°çš„é‚£æ ·ï¼Œè¿™ç»™äº†æ”»å‡»è€…ç¯¡æ”¹ä»£ç çš„æœºä¼šã€‚æ¯”å¦‚ï¼š

```c
void hack() {
    // 1. ä¿®æ”¹ä»£ç 
    void* code = (void*)hack;
    *(char*)code = 0x90;     // å¦‚æœä»£ç æ®µå¯å†™ï¼Œç¨‹åºå¯ä»¥è¢«ç¯¡æ”¹ï¼

    // 2. æ‰§è¡Œæ•°æ®
    char shellcode[] = {...}; // ä¸€äº›æ¶æ„ä»£ç 
    ((void(*)())shellcode)(); // å¦‚æœæ•°æ®æ®µå¯æ‰§è¡Œï¼Œè¿™å°±æ˜¯æ¼æ´ï¼
}
```

ä¸ºäº†é˜²æ­¢è¿™äº›æ”»å‡»ï¼Œç°ä»£ç³»ç»Ÿé‡‡ç”¨åˆ†æ®µæœºåˆ¶ï¼š

1. ä»£ç æ®µï¼ˆ.textï¼‰ï¼šåªè¯»ä¸”å¯æ‰§è¡Œ
2. åªè¯»æ•°æ®æ®µï¼ˆ.rodataï¼‰ï¼šåªè¯»
3. æ•°æ®æ®µï¼ˆ.dataï¼‰ï¼šå¯è¯»å†™
4. BSS æ®µï¼ˆ.bssï¼‰ï¼šå¯è¯»å†™ï¼Œä½†ä¸å æ–‡ä»¶ç©ºé—´

ç¼–è¯‘å™¨å·²ç»å¸®æˆ‘ä»¬åˆ†å¥½äº†æ®µï¼š

```json
{
  "type": ".obj",

  ".text": [
    "ğŸ“¤: main 40",
    "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 be 00 00 00 00 48 8d 05",
    "â“: .rel(.rodata - 4)",
    "ğŸ”¢: 48 89 c7 b8 00 00 00 00 e8",
    "â“: .rel(print - 4)",
    "ğŸ”¢: b8 00 00 00 00 5d c3"
  ],
  ".data": [
    "ğŸ“¤: counter 4",
    "ğŸ”¢: 03 00 00 00" // å·²åˆå§‹åŒ–æ•°æ®
  ],
  ".bss": [
    "ğŸ“¤: buffer 4096" // æœªåˆå§‹åŒ–æ•°æ®ï¼Œåªè®°å½•å¤§å°
  ],
  ".rodata": [
    "ğŸ·ï¸: .rodata 0",
    "ğŸ”¢: 48 65 6c 6c 6f 00" // "Hello"
  ]
}
```

ä½ çš„ä»»åŠ¡æ˜¯ï¼š

1. ä¿æŒæ®µçš„ç‹¬ç«‹æ€§ï¼ˆä¸è¦åˆå¹¶ï¼‰
2. è®¾ç½®æ­£ç¡®çš„æƒé™ï¼š
   - `.text`: r-xï¼ˆè¯»/æ‰§è¡Œï¼‰
   - `.rodata`: r--ï¼ˆåªè¯»ï¼‰
   - `.data`: rw-ï¼ˆè¯»/å†™ï¼‰
   - `.bss`: rw-ï¼ˆè¯»/å†™ï¼‰
3. ä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼š
   - 4KB å¯¹é½ï¼ˆé¡µé¢å¤§å°ï¼‰
   - ç›¸ä¼¼æƒé™çš„æ®µæ”¾åœ¨ä¸€èµ·
   - BSS æ®µä¸éœ€è¦æ–‡ä»¶å†…å®¹

BSSï¼ˆBlock Started by Symbolï¼‰æ®µæ˜¯ä¸€ä¸ªç‹¬ç‰¹çš„æ®µï¼Œå®ƒå­˜å‚¨äº†ç¨‹åºä¸­æ‰€æœ‰æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚ä¸å…¶ä»–æ®µä¸åŒï¼ŒBSS æ®µåœ¨æ–‡ä»¶ä¸­ä¸å ç”¨å®é™…ç©ºé—´ï¼Œåªè®°å½•å¤§å°ä¿¡æ¯ã€‚

BSS æ®µçš„é“¾æ¥è¿‡ç¨‹éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. è®¡ç®—æ€»å¤§å°ï¼š

   - éå†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ï¼Œç´¯åŠ å®ƒä»¬çš„ BSS æ®µå¤§å°
   - å¾—åˆ°æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ä¸­ BSS æ®µæ‰€éœ€çš„ç©ºé—´å¤§å°
   - è¿™ä¸ªå¤§å°å°†ç”¨äºå†…å­˜åˆ†é…

2. ç¬¦å·é‡å®šä½ï¼š
   - æ”¶é›†æ‰€æœ‰åœ¨ BSS æ®µä¸­å®šä¹‰çš„ç¬¦å·
   - è®¡ç®—æ¯ä¸ªç¬¦å·åœ¨åˆå¹¶åçš„ BSS æ®µä¸­çš„æ–°ä½ç½®
   - æ›´æ–°æ‰€æœ‰å¼•ç”¨è¿™äº›ç¬¦å·çš„é‡å®šä½æ¡ç›®
   - ç¡®ä¿é‡å®šä½åçš„åœ°å€æ­£ç¡®æŒ‡å‘ BSS æ®µä¸­çš„ç›®æ ‡ä½ç½®

> [!TIP]
>
> åœ¨å¤„ç† `.bss` æ®µçš„ç¬¦å·æ—¶ï¼Œä½ å¯èƒ½éœ€è¦ç‰¹åˆ«å…³æ³¨ `Symbol` ç»“æ„ä½“ä¸­çš„ `offset` å­—æ®µã€‚å®ƒè¡¨ç¤ºä¸€ä¸ªç¬¦å·åœ¨å®ƒæ‰€å±çš„èŠ‚ä¸­çš„åç§»é‡ã€‚
> ä»¥åŠä½ å¯èƒ½è¿˜ä¼šç”¨åˆ° `SectionHeader` ç»“æ„ä½“ä¸­çš„ `size` å­—æ®µæ¥è®¡ç®—é“¾æ¥å `.bss` æ®µçš„æ€»å¤§å°ã€‚
>
> å‚è§ [`include/fle.hpp`](./include/fle.hpp) ä¸­çš„ `Symbol` å’Œ `SectionHeader` ç»“æ„ä½“ã€‚

æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```json
{
    "type": "exe",
    "phdrs": [
        {
            "name": ".text",
            "vaddr": 0x400000,
            "size": <ä»£ç å¤§å°>,
            "flags": 5        // r-x
        },
        {
            "name": ".rodata",
            "vaddr": <å¯¹é½åçš„åœ°å€>,
            "size": <å¸¸é‡å¤§å°>,
            "flags": 4        // r--
        },
        // ...å…¶ä»–æ®µ...
    ],
    "entry": <å…¥å£åœ°å€>,
    ".text": { ... }, // ä»£ç 
    ".rodata": { ... }, // å¸¸é‡
    ".data": { ... }, // å·²åˆå§‹åŒ–æ•°æ®
    ".bss": { ... } // æœªåˆå§‹åŒ–æ•°æ®
}
```

æç¤ºï¼š

1. æ®µçš„åœ°å€è¦é€‚å½“å¯¹é½ï¼Œå¦åˆ™ä¼šå½±å“æ€§èƒ½ï¼Œä¸”ä¼šå½±å“ loader ä¸­ `mmap` çš„åˆ†é…
2. æ³¨æ„æ›´æ–°æ‰€æœ‰é‡å®šä½ï¼Œå› ä¸ºåœ°å€éƒ½å˜äº†
3. BSS æ®µåªéœ€è¦åˆ†é…ç©ºé—´ï¼Œä¸éœ€è¦æ•°æ®ï¼ŒèŠ‚çœäº†ç©ºé—´
4. è€ƒè™‘æŠŠç›¸ä¼¼æƒé™çš„æ®µåˆå¹¶åˆ°ä¸€ä¸ªç¨‹åºå¤´ä¸­

ä¿®æ”¹ `src/student/ld.cpp`ï¼Œå®ç°å†…å­˜å¸ƒå±€çš„ä¼˜åŒ–ã€‚

### éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š

```bash
make test_6
```

## ä»»åŠ¡ä¸ƒï¼šéªŒè¯ä¸æ€»ç»“

æ­å–œä½ å®Œæˆäº†æ‰€æœ‰åŸºç¡€ä»»åŠ¡ï¼ç°åœ¨è®©æˆ‘ä»¬éªŒè¯æ•´ä¸ªé“¾æ¥å™¨çš„åŠŸèƒ½ã€‚

### å®Œæ•´æ€§æ£€æŸ¥

```bash
make test
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

```
Preparing FLE Tools...
âœ“ FLE Tools compiled successfully
Preparing minilibc...
âœ“ minilibc compiled successfully

Running 12 test cases...

âœ“ nm Tool Test [2/2]: Passed
âœ“ Single File Test [3/3]: Passed
âœ“ Absolute Addressing Test [3/3]: Passed
âœ“ Absolute + Relative Addressing Test [4/4]: Passed
âœ“ Position Independent Executable Test [5/5]: Passed
âœ“ Strong Symbol Conflict Test [3/3]: Passed
âœ“ Weak Symbol Override Test [4/4]: Passed
âœ“ Multiple Weak Symbol Warning [5/5]: Passed
âœ“ Local Symbol Access Test [3/3]: Passed
âœ“ 64-bit Absolute Relocation Test [3/3]: Passed
âœ“ BSS Section Linking Test [5/5]: Passed
âœ“ Section Permission Control Test [10/10]: Passed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Test Case                           â”ƒ Result â”ƒ  Time â”ƒ     Score â”ƒ Message             â”ƒ
â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ nm Tool Test                        â”‚  PASS  â”‚ 0.36s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Single File Test                    â”‚  PASS  â”‚ 0.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute Addressing Test            â”‚  PASS  â”‚ 0.29s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute + Relative Addressing Test â”‚  PASS  â”‚ 0.60s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Position Independent Executable     â”‚  PASS  â”‚ 0.93s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Test                                â”‚        â”‚       â”‚           â”‚                     â”‚
â”‚ Strong Symbol Conflict Test         â”‚  PASS  â”‚ 0.70s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Weak Symbol Override Test           â”‚  PASS  â”‚ 0.78s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Multiple Weak Symbol Warning        â”‚  PASS  â”‚ 0.85s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Local Symbol Access Test            â”‚  PASS  â”‚ 0.46s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ 64-bit Absolute Relocation Test     â”‚  PASS  â”‚ 0.37s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ BSS Section Linking Test            â”‚  PASS  â”‚ 0.77s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Section Permission Control Test     â”‚  PASS  â”‚ 1.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Total Score: 120.0/120.0 (100.0%)                                                      â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

```

### å®éªŒæŠ¥å‘Šè¦æ±‚

è¯·å‚è€ƒ[æŠ¥å‘Šæ¨¡æ¿é€šç”¨æŒ‡å—](./report/README.md)ï¼ŒåŸºäº[å®éªŒæŠ¥å‘Šæ¨¡æ¿](./report/report.md)ï¼Œå®Œæˆå®éªŒæŠ¥å‘Šã€‚

## å®Œæˆæœ¬å®éªŒ

### æäº¤

æˆ‘ä»¬ä½¿ç”¨ GitHub Classroom è¿›è¡Œæäº¤ï¼š

1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤åˆ°ä½ çš„ä»“åº“
2. GitHub Actions ä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•
3. æˆ‘ä»¬å°†ä»¥ Actions çš„è¾“å‡ºä½œä¸ºè¯„åˆ†ä¾æ®

### è¯„åˆ†æ ‡å‡†

åˆ†æ•°ç”±æ­£ç¡®æ€§å¾—åˆ†å’Œä»£ç è´¨é‡å¾—åˆ†ç»„æˆï¼Œæ­£ç¡®æ€§å¾—åˆ†å  80%ï¼Œä»£ç è´¨é‡å¾—åˆ†å  20%ï¼Œå³ï¼š

$$
\text{æ€»åˆ†} = \frac{\text{æ­£ç¡®æ€§å¾—åˆ†}} {\text{æ­£ç¡®æ€§æ»¡åˆ†}} \times 80\% + \text{ä»£ç è´¨é‡å¾—åˆ†} \times 20\%
$$

å…¶ä¸­ï¼Œæ­£ç¡®æ€§å¾—åˆ†ç”± GitHub Classroom è‡ªåŠ¨è®¡ç®—ï¼Œä»£ç è´¨é‡å¾—åˆ†ç”±åŠ©æ•™æ ¹æ®ä»£ç é£æ ¼å’Œå®éªŒæŠ¥å‘Šè¯„åˆ†ï¼Œå…·ä½“è¡¡é‡å› ç´ ä¸ºï¼š

- ä»£ç é£æ ¼
  - ä»£ç è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œé€»è¾‘æ¸…æ™°ï¼Œä»£ç ç®€æ´ï¼Œä»…åœ¨å¿…è¦æ—¶æ·»åŠ æ³¨é‡Š
  - ç§¯æä½¿ç”¨ C++ æ ‡å‡†åº“ï¼Œä¸é‡å¤é€ è½®å­
  - é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œè¿›è¡Œå¤šå±‚æ¬¡çš„é”™è¯¯æ£€æŸ¥
- å®éªŒæŠ¥å‘Š
  - å®éªŒæŠ¥å‘Šå†…å®¹å®Œæ•´ï¼Œæ ¼å¼è§„èŒƒï¼Œæ’ç‰ˆç¾è§‚
  - å®éªŒæŠ¥å‘Šå†…å®¹ä¸ä»£ç ä¸€è‡´ï¼Œæ— æ˜æ˜¾çŸ›ç›¾ï¼Œä½“ç°å‡ºå¯¹å®éªŒè€ƒå¯ŸçŸ¥è¯†çš„åŸºæœ¬äº†è§£
  - æœ‰æ€è€ƒï¼Œæœ‰æ€»ç»“ï¼Œæœ‰åæ€ï¼Œæœ‰åˆ›æ–°
  - å¯¹å®éªŒæä¾›æœ‰ä»·å€¼çš„åé¦ˆå’Œå»ºè®®

## è°ƒè¯•å»ºè®®

1. ä»”ç»†é˜…è¯» `include/fle.hpp` ä¸­çš„æ•°æ®ç»“æ„å®šä¹‰
2. ä½¿ç”¨ `readfle` å·¥å…·æŸ¥çœ‹ FLE æ–‡ä»¶çš„å†…å®¹
3. æµ‹è¯•ç”¨ä¾‹æä¾›äº†å¾ˆå¥½çš„å‚è€ƒå®ä¾‹
4. é“¾æ¥å™¨çš„è°ƒè¯•æŠ€å·§ï¼š
   - ä½¿ç”¨ `objdump` æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
   - æ‰“å°ä¸­é—´è¿‡ç¨‹çš„é‡è¦ä¿¡æ¯
   - åˆ†æ­¥éª¤å®ç°ï¼Œå…ˆç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£ç¡®

## è¿›é˜¶å†…å®¹

å®Œæˆäº†åŸºæœ¬ä»»åŠ¡åï¼Œä½ å¯ä»¥å°è¯•ï¼š

1. æ”¯æŒæ›´å¤šçš„é‡å®šä½ç±»å‹
2. å®ç°å…±äº«åº“åŠ è½½
3. æ·»åŠ ç¬¦å·ç‰ˆæœ¬æ§åˆ¶
4. ä¼˜åŒ–é“¾æ¥æ€§èƒ½
5. æ”¯æŒå¢é‡é“¾æ¥

è¿™äº›å†…å®¹ä¸ä¼šè®¡å…¥æœ¬æ¬¡å®éªŒçš„è¯„åˆ†ï¼Œå­¦æœ‰ä½™åŠ›çš„åŒå­¦å¯ä»¥è‡ªè¡Œæ¢ç´¢ã€‚

## å‚è€ƒèµ„æ–™

1. [CSAPP: Computer Systems A Programmer's Perspective](https://csapp.cs.cmu.edu/)
2. [System V ABI](https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf)
3. [Linkers & Loaders](https://linker.iecc.com/)
4. [How To Write Shared Libraries](https://www.akkadia.org/drepper/dsohowto.pdf)
