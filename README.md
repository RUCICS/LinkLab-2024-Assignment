# LinkLab 2024ï¼šæ„å»ºä½ è‡ªå·±çš„é“¾æ¥å™¨

```
 ___       ___  ________   ___  __    ___       ________  ________
|\  \     |\  \|\   ___  \|\  \|\  \ |\  \     |\   __  \|\   __  \
\ \  \    \ \  \ \  \\ \  \ \  \/  /|\ \  \    \ \  \|\  \ \  \|\ /_
 \ \  \    \ \  \ \  \\ \  \ \   ___  \ \  \    \ \   __  \ \   __  \
  \ \  \____\ \  \ \  \\ \  \ \  \\ \  \ \  \____\ \  \ \  \ \  \|\  \
   \ \_______\ \__\ \__\\ \__\ \__\\ \__\ \_______\ \__\ \__\ \_______\
    \|_______|\|__|\|__| \|__|\|__| \|__|\|_______|\|__|\|__|\|_______|
```

> æ¯ä¸ªç¨‹åºå‘˜éƒ½ç”¨è¿‡é“¾æ¥å™¨ï¼Œä½†å¾ˆå°‘æœ‰äººçœŸæ­£ç†è§£å®ƒã€‚
>
> åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œä½ å°†äº²æ‰‹å®ç°ä¸€ä¸ªé“¾æ¥å™¨ï¼Œæ­å¼€ç¨‹åºæ˜¯å¦‚ä½•è¢«â€œæ‹¼æ¥â€åœ¨ä¸€èµ·çš„ç§˜å¯†ã€‚æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå‹å¥½çš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆFLEï¼‰ï¼Œè®©ä½ å¯ä»¥ä¸“æ³¨äºç†è§£é“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µã€‚

> [!WARNING]
> è¿™æ˜¯ LinkLab çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å¦‚æœä½ ï¼š
>
> - å‘ç°äº† Bugï¼Œè¯·[æäº¤ Issue](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)
> - æœ‰ä»»ä½• Questionï¼Œè¯·åœ¨[è®¨è®ºåŒº](https://github.com/RUCICS/LinkLab-2024-Assignment/discussions)æå‡º
>
> ä¹Ÿæ¬¢è¿ä½ ç§¯æå‚ä¸å¼€æºåä½œï¼Œæ”¹è¿›æ¡†æ¶ä»£ç è§£å†³ Issueã€æˆ–æ˜¯ä¸ºåŒå­¦ä»¬ç­”ç–‘è§£æƒ‘ã€‚è¿™éƒ¨åˆ†çš„è¡¨ç°å¯è¢«è®¡ä¸º[é¢å¤–çš„åˆ†æ•°](#è¯„åˆ†æ ‡å‡†)ã€‚

> [!NOTE]
> æœ¬å®éªŒé¢„è®¡è€—æ—¶ 7 - 15 ä¸ªå°æ—¶ï¼Œå…·ä½“æƒ…å†µå› ä¸ªä½“å·®å¼‚å¯èƒ½æœ‰æ‰€åŒºåˆ«ã€‚

[![GitHub Issues](https://img.shields.io/github/issues/RUCICS/LinkLab-2024-Assignment?style=for-the-badge&logo=github)](https://github.com/RUCICS/LinkLab-2024-Assignment/issues)

## ä»€ä¹ˆæ˜¯é“¾æ¥ï¼Ÿ

é“¾æ¥æ˜¯å°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ç»„åˆæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºçš„è¿‡ç¨‹ã€‚åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘ä¼šæŠŠæ‰€æœ‰ä»£ç éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œ â€”â€” è¿™æ ·æ—¢ä¸åˆ©äºä»£ç å¤ç”¨ï¼Œä¹Ÿä¸ä¾¿äºå›¢é˜Ÿåä½œã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šå°†ç¨‹åºåˆ†è§£æˆå¤šä¸ªæºæ–‡ä»¶ï¼Œåˆ†åˆ«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œå†é€šè¿‡é“¾æ¥å™¨å°†å®ƒä»¬"æ‹¼æ¥"åœ¨ä¸€èµ·ã€‚

é“¾æ¥å™¨çš„ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š

1. ç¬¦å·è§£æï¼šå°†ä»£ç ä¸­çš„ç¬¦å·ï¼ˆå¦‚å‡½æ•°è°ƒç”¨ã€å…¨å±€å˜é‡ï¼‰ä¸å®ƒä»¬çš„å®šä¹‰å¯¹åº”èµ·æ¥
2. é‡å®šä½ï¼šè°ƒæ•´ç¬¦å·çš„åœ°å€ï¼Œç¡®ä¿ç¨‹åºåœ¨å†…å­˜ä¸­æ­£ç¡®è¿è¡Œ
3. å¸ƒå±€è§„åˆ’ï¼šåˆç†å®‰æ’å„ä¸ªéƒ¨åˆ†åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå¹¶è®¾ç½®é€‚å½“çš„è®¿é—®æƒé™

è¿™ä¸ªè¿‡ç¨‹çœ‹ä¼¼ç®€å•ï¼Œä½†å®é™…ä¸Šæ¶‰åŠè®¸å¤šå¤æ‚çš„ç»†èŠ‚ï¼šå¦‚ä½•å¤„ç†ç¬¦å·å†²çªï¼Ÿå¦‚ä½•ä¿®æ­£ç›®æ ‡åœ°å€ï¼Ÿå¦‚ä½•ä¿æŠ¤ä»£ç ä¸è¢«ç¯¡æ”¹ï¼Ÿåœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œä½ å°†äº²æ‰‹å®ç°è¿™äº›åŠŸèƒ½ï¼Œæ·±å…¥ç†è§£ç°ä»£ç¨‹åºæ˜¯å¦‚ä½•è¢«ç»„è£…èµ·æ¥çš„ã€‚

## ç¯å¢ƒè¦æ±‚

- æ“ä½œç³»ç»Ÿï¼šLinuxï¼ˆæ¨è Ubuntu 22.04 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
  - Windows ç”¨æˆ·å¯è€ƒè™‘ä½¿ç”¨ WSL 2
- ç¼–è¯‘å™¨ï¼šg++ 12.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆéœ€è¦ C++17ï¼‰
- Python 3.6+
- Makefile
- Git

è¯·ä½¿ç”¨ Git ç®¡ç†ä½ çš„ä»£ç ï¼Œå…»æˆç»å¸¸æäº¤çš„å¥½ä¹ æƒ¯ã€‚

## å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†ä»“åº“ï¼ˆè¯·å°† your-assignment-repo-url æ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git clone your-assignment-repo-url
cd your-assignment-repo-name

# æ„å»ºé¡¹ç›®
make

# è¿è¡Œæµ‹è¯•ï¼ˆæ­¤æ—¶åº”è¯¥ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
make test_1  # è¿è¡Œä»»åŠ¡ä¸€çš„æµ‹è¯•
make test    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

## é¡¹ç›®ç»“æ„

```
LinkLab-2024/
â”œâ”€â”€ include/                    # å¤´æ–‡ä»¶
â”‚   â””â”€â”€ fle.hpp                # FLE æ ¼å¼å®šä¹‰ï¼ˆè¯·ä»”ç»†é˜…è¯»ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ base/                  # åŸºç¡€æ¡†æ¶ï¼ˆåŠ©æ•™æä¾›ï¼‰
â”‚   â”‚   â”œâ”€â”€ cc.cpp            # ç¼–è¯‘å™¨å‰ç«¯ï¼Œç”Ÿæˆ FLE æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ exec.cpp          # ç¨‹åºåŠ è½½å™¨ï¼Œè¿è¡Œç”Ÿæˆçš„ç¨‹åº
â”‚   â””â”€â”€ student/              # ä½ éœ€è¦å®Œæˆçš„ä»£ç 
â”‚       â”œâ”€â”€ nm.cpp            # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æŸ¥çœ‹å™¨
â”‚       â””â”€â”€ ld.cpp            # ä»»åŠ¡äºŒ~å…­ï¼šé“¾æ¥å™¨ä¸»ç¨‹åº
â””â”€â”€ tests/                    # æµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ cases/               # æŒ‰ä»»åŠ¡åˆ†ç±»çš„æµ‹è¯•
        â”œâ”€â”€ 1-nm-test/      # ä»»åŠ¡ä¸€ï¼šç¬¦å·è¡¨æ˜¾ç¤º
        â”œâ”€â”€ 2-ld-test/      # ä»»åŠ¡äºŒï¼šåŸºç¡€é“¾æ¥
        â””â”€â”€ ...             # æ›´å¤šæµ‹è¯•ç”¨ä¾‹
    â””â”€â”€ common/              # æµ‹è¯•ç”¨ä¾‹çš„å…¬å…±åº“
        â””â”€â”€ minilibc.c       # è¿·ä½  libc çš„å®ç°
```

æ¯ä¸ªä»»åŠ¡éƒ½é…æœ‰å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬ï¼š

- æºä»£ç ï¼šç”¨äºç”Ÿæˆæµ‹è¯•è¾“å…¥
- æœŸæœ›è¾“å‡ºï¼šç”¨äºéªŒè¯ä½ çš„å®ç°
- é…ç½®æ–‡ä»¶ï¼šå®šä¹‰æµ‹è¯•å‚æ•°

ä½ å¯ä»¥ï¼š

1. é˜…è¯»æµ‹è¯•ä»£ç äº†è§£å…·ä½“è¦æ±‚
2. è¿è¡Œæµ‹è¯•æ£€æŸ¥å®ç°æ˜¯å¦æ­£ç¡®
3. ä¿®æ”¹æµ‹è¯•æ¢ç´¢æ›´å¤šå¯èƒ½æ€§
4. æ·»åŠ æ›´å¤šæµ‹è¯•ç‚¹æ¥å¢å¼ºç¨‹åºçš„å¥å£®æ€§

// æ”¯æŒå—ï¼Ÿ

## ä»»åŠ¡é›¶ï¼šç†è§£ç›®æ ‡æ–‡ä»¶æ ¼å¼

Linux ä½¿ç”¨ **ELF æ ¼å¼**æ¥ç»„ç»‡å’Œå­˜å‚¨å¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶å’Œå…±äº«åº“ï¼Œéå¸¸å¼ºå¤§å’Œçµæ´»ã€‚ç„¶è€Œï¼Œè¿™ç§æ ¼å¼å¹¶ä¸æ˜¯é¢å‘äººç±»å¯è¯»è€Œè®¾è®¡çš„ï¼Œå®ƒçš„è¡¨è¾¾å½¢å¼å’Œéšå«çš„å¤§é‡çç¢ç»†èŠ‚å¯¹äºåˆå­¦è€…è€Œè¨€æœ‰æå¤§çš„è®¤çŸ¥æˆæœ¬ã€‚ä¸ºäº†è®©ä½ ä¸“æ³¨äºé“¾æ¥çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬é‡æ–°è®¾è®¡äº† *FLE (Friendly Linking Executable)* ï¼Œæä¾›ä¸€ç§æ›´å¹³å¦ã€æ›´äººç±»å‹å¥½ã€æ›´ç¬¦åˆè¡Œä¸ºå±€éƒ¨æ€§åŸåˆ™ï¼ˆLocality of Bahaviour Principleï¼‰çš„æ ¼å¼ã€‚


ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº† C ä»£ç åŠå…¶ç¼–è¯‘åçš„ç›®æ ‡æ–‡ä»¶å†…å®¹ï¼ˆä½†æ˜¯ FLE æ ¼å¼ï¼‰ï¼š

```c
// test.c
int message[2] = {1, 2};  // å…¨å±€æ•°ç»„

static int helper(int x) { // é™æ€å‡½æ•°
    return x + message[0];
}

int main() {             // ç¨‹åºå…¥å£
    return helper(42);
}
```

é€šè¿‡ `./cc test.c -o test.o`ï¼Œå¯ç”Ÿæˆ `test.fle` å†…å®¹å¦‚ä¸‹ï¼š

```json5
{
    "type": ".obj", // è¿™æ˜¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶
    "shdrs": [
        // å„ä¸ªèŠ‚çš„å…ƒæ•°æ®
        {
            "name": ".text", // èŠ‚å
            "type": 1, // èŠ‚ç±»å‹
            "flags": 1, // èŠ‚æƒé™
            "addr": 0, // èŠ‚åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
            "offset": 0, // èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
            "size": 36  // èŠ‚çš„å¤§å°
        },
        {
            "name": ".data",
            "type": 1,
            "flags": 1,
            "addr": 0,
            "offset": 0,
            "size": 8
        },
        {
            "name": ".bss",
            "type": 8,
            "flags": 9,
            "addr": 0,
            "offset": 0,
            "size": 0
        }
    ],
    ".text": [
        "ğŸ·ï¸: helper 20 0", // å±€éƒ¨ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 89 7d fc 8b 15", // æœºå™¨ç 
        "â“: .rel(message - 4)", // éœ€è¦é‡å®šä½
        "ğŸ”¢: 8b 45 fc 01 d0 5d c3", // æœºå™¨ç 
        "ğŸ“¤: main 16 20", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 bf 2a 00 00 00 e8 de ff ff ff 5d c3" // æœºå™¨ç 
    ],
    ".data": [
        "ğŸ“¤: message 8 0", // å…¨å±€ç¬¦å·
        "ğŸ”¢: 01 00 00 00 02 00 00 00" // æ•°æ®
    ],
    ".bss": []
}
```

FLE ä½¿ç”¨è¡¨æƒ…ç¬¦å·æ¥æ ‡è®°ä¸åŒç±»å‹çš„ä¿¡æ¯ï¼š

1. æœºå™¨ç  `å­—èŠ‚ å­—èŠ‚ å­—èŠ‚ ...` ğŸ”¢
2. ç¬¦å· `ç¬¦å·å å¤§å° èŠ‚å†…åç§»é‡`
  - æ–‡ä»¶å†…éƒ¨çš„å±€éƒ¨ç¬¦å· ğŸ·ï¸
  - å¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨çš„å…¨å±€ç¬¦å·ï¼ˆå¼ºç¬¦å·ï¼‰ ğŸ“¤
  - å¯ä»¥è¢«è¦†ç›–çš„å…¨å±€å¼±ç¬¦å· ğŸ“
3. é‡å®šä½ `é‡å®šä½ç±»å‹(ç›®æ ‡ç¬¦å·å [+/-] é™„åŠ å€¼)` â“

è¿™äº›ä¿¡æ¯åœ¨å†…å­˜ä¸­ç”¨ C++ ç»“æ„ä½“ `FLEObject` è¡¨ç¤ºï¼ˆå®šä¹‰åœ¨ [`include/fle.hpp`](include/fle.hpp) ä¸­ï¼‰ï¼š

```cpp
struct FLEObject {
    std::string name; // Object name
    std::string type; // ".obj" or ".exe"
    std::map<std::string, FLESection> sections; // Section name -> section data
    std::vector<Symbol> symbols; // Global symbol table
    std::vector<ProgramHeader> phdrs; // Program headers (for .exe)
    std::vector<SectionHeader> shdrs; // Section headers
    size_t entry = 0; // Entry point (for .exe)
};

struct FLESection {
    std::vector<uint8_t> data; // Section data (stored as bytes)
    std::vector<Relocation> relocs; // Relocation table for this section
    bool has_symbols; // Whether section contains symbols
};

// â€¦â€¦
```

æˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¼šè‡ªåŠ¨å°†ç£ç›˜ä¸Šçš„ *FLE æ ¼å¼æ–‡ä»¶*åŠ è½½ä¸ºå†…å­˜ä¸­çš„*ç»“æ„ä½“ `FLEObject`*ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå«**ååºåˆ—åŒ–**ã€‚åœ¨å®ç°é“¾æ¥å™¨æ—¶ï¼Œä½ å¯èƒ½æ›´å¤šéœ€è¦å…³æ³¨ `FLEObject`ï¼›FLE æ ¼å¼æ–‡ä»¶ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹å’Œè°ƒè¯•ã€‚

> [!IMPORTANT]
> FLE æ ¼å¼æ–‡ä»¶å’Œ `FLEObject` å¤§éƒ¨åˆ†å†…å®¹æ˜¯å¯¹åº”çš„ï¼Œä½†åœ¨æŸäº›æ•°æ®çš„è¡¨ç¤ºä¸Šæœ‰æ‰€ä¸åŒã€‚å…·ä½“æ¥è¯´ï¼š
>
> - åœ¨ FLE æ ¼å¼æ–‡ä»¶ä¸­ï¼Œé‡å®šä½å’Œç¬¦å·å®šä¹‰æ˜¯å†…è”çš„ã€‚ç¬¦å·å®šä¹‰çš„åœ°æ–¹ç›´æ¥ç”¨ ğŸ“¤ / ğŸ“ / ğŸ·ï¸ æ ‡è®°ï¼›è€Œåœ¨ `FLEObject` ä¸­ï¼Œç¬¦å·è¡¨æ˜¯ç‹¬ç«‹çš„ï¼ŒåŒ…å«æ¯ä¸ªç¬¦å·åŠå…¶å®šä¹‰ä½ç½®çš„ä¿¡æ¯ï¼Œå¹¶ä¸”æ¯ä¸ª `FLESection` ä¸­æœ‰ç‹¬ç«‹çš„é‡å®šä½è¡¨ã€‚
> - åœ¨ FLE æ ¼å¼æ–‡ä»¶ä¸­ï¼Œéœ€è¦é‡å®šä½çš„åœ°æ–¹ç›´æ¥ç”¨ â“ å†…è”æ ‡è®°ï¼Œ**ä¸å­˜åœ¨å ä½çš„ 0 å­—èŠ‚**ï¼›è€Œåœ¨æ¯ä¸ª `FLESection` çš„ `data` å­—æ®µä¸­ï¼Œéœ€è¦é‡å®šä½çš„åœ°æ–¹ä¼šç”¨ 0 å ä½ã€‚


åœ¨æ¥ä¸‹æ¥çš„ä»»åŠ¡ä¸­ï¼Œä½ å°†é€æ­¥å®ç°å¤„ç†è¿™ç§æ ¼å¼çš„å·¥å…·é“¾ï¼Œä»æœ€åŸºæœ¬çš„ç¬¦å·è¡¨æŸ¥çœ‹å™¨å¼€å§‹ï¼Œæœ€ç»ˆå®ç°ä¸€ä¸ªå®Œæ•´çš„é“¾æ¥å™¨ã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼

## ä»»åŠ¡ä¸€ï¼šçª¥æ¢ç¨‹åºçš„ç¬¦å·è¡¨

ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„é”™è¯¯ï¼Ÿ

```
undefined reference to `printf'
multiple definition of `main'
```

è¿™äº›éƒ½ä¸ç¬¦å·ï¼ˆsymbolï¼‰æœ‰å…³ã€‚ç¬¦å·å°±åƒç¨‹åºä¸­çš„"åå­—"ï¼Œä»£è¡¨äº†å‡½æ•°ã€å˜é‡ç­‰ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†è§£ï¼š

```c
static int counter = 0;        // é™æ€å˜é‡ï¼šæ–‡ä»¶å†…å¯è§
int shared = 42;              // å…¨å±€å˜é‡ï¼šå…¶ä»–æ–‡ä»¶å¯è§
extern void print(int x);     // å¤–éƒ¨å‡½æ•°ï¼šéœ€è¦å…¶ä»–æ–‡ä»¶æä¾›

void count() {                // å…¨å±€å‡½æ•°
    counter++;                // è®¿é—®é™æ€å˜é‡
    print(counter);           // è°ƒç”¨å¤–éƒ¨å‡½æ•°
}
```

è¿™æ®µä»£ç ä¸­åŒ…å«äº†å‡ ç§ä¸åŒçš„ç¬¦å·ï¼š

- `counter`ï¼šé™æ€ç¬¦å·ï¼Œåªåœ¨æ–‡ä»¶å†…å¯è§
- `shared`ï¼šå…¨å±€ç¬¦å·ï¼Œå¯ä»¥è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨
- `print`ï¼šæœªå®šä¹‰ç¬¦å·ï¼Œéœ€è¦åœ¨é“¾æ¥æ—¶æ‰¾åˆ°
    - ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥æ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼Œæ‰€æœ‰çš„ FLE æ ¼å¼æ–‡ä»¶å’Œ `FLEObject` ä¸­éƒ½ä¸å­˜åœ¨æœªå®šä¹‰ç¬¦å·
- `count`ï¼šå…¨å±€å‡½æ•°ç¬¦å·

ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯è¡¥å…… [src/student/nm.cpp](src/student/nm.cpp) ä¸­çš„ `FLE_nm` å‡½æ•°ï¼Œå®ç°ä¸€ä¸ªå·¥å…·ï¼ˆnmï¼‰æ¥æŸ¥çœ‹è¿™äº›ç¬¦å·ã€‚å¯¹äºä¸Šé¢çš„ä»£ç ï¼Œå®ƒåº”è¯¥è¾“å‡ºä¸‰è¡Œä¸‰åˆ—ä¿¡æ¯ï¼š

```
0000000000000000 T count    # å…¨å±€å‡½æ•°åœ¨ .text èŠ‚
0000000000000000 b counter  # é™æ€å˜é‡åœ¨ .bss èŠ‚
0000000000000000 D shared   # å…¨å±€å˜é‡åœ¨ .data èŠ‚
```

æ¯ä¸€åˆ—çš„å…·ä½“å«ä¹‰æ˜¯ï¼š

- åœ°å€ï¼šç¬¦å·**åœ¨å…¶æ‰€åœ¨èŠ‚ä¸­**çš„åç§»é‡
- ç±»å‹ï¼šç¬¦å·çš„ç±»å‹å’Œä½ç½®
  - å¤§å†™ï¼ˆTã€Dã€Bã€Rï¼‰ï¼šå…¨å±€ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - å°å†™ï¼ˆtã€dã€bã€rï¼‰ï¼šå±€éƒ¨ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€æ•°æ®æ®µã€BSS æ®µã€åªè¯»æ•°æ®æ®µ
  - Wã€Vï¼šå¼±ç¬¦å·ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨ä»£ç æ®µã€è¿˜æ˜¯åœ¨æ•°æ®æ®µæˆ– BSS æ®µ
- åç§°ï¼šç¬¦å·çš„åå­—

è¦å®ç°è¿™ä¸ªå·¥å…·ï¼Œä½ éœ€è¦éå†ç¬¦å·è¡¨ï¼Œç¡®å®šæ¯ä¸ªç¬¦å·çš„ç±»å‹ï¼Œå¹¶æŒ‰æ ¼å¼æ‰“å°ä¿¡æ¯ã€‚

> [!TIP]
> æ ¼å¼åŒ–è¾“å‡ºå¯ä»¥ä½¿ç”¨:
>  ```cpp
>  std::cout << std::setw(16) << std::setfill('0') << std::hex << addr;  // C++ é£æ ¼
>  ```
>  æˆ–
>  ```c
>  printf("%016lx", addr);  // C é£æ ¼,è¾“å‡º16ä½çš„åå…­è¿›åˆ¶æ•°,å·¦ä¾§è¡¥0
>  ```
>  ä»¥åŠï¼Œåœ¨ C++ 20 åï¼Œ`std::format` å’Œ `std::print` æä¾›äº†æ›´ç®€æ´çš„æ ¼å¼åŒ–æ–¹æ¡ˆï¼ˆæœ¬å®éªŒä½¿ç”¨ `-std=c++17` ç¼–è¯‘é€‰é¡¹ï¼Œä¸æ”¯æŒæ­¤ç‰¹æ€§ã€‚æ­¤æ–¹æ¡ˆä»…ä¾›äº†è§£ï¼‰
>  ```cpp
>  std::print("{:016x}", addr);  // Modern C++ é£æ ¼
>  ```

> [!TIP]
> ä½ å¯ä»¥æ ¹æ®ç¬¦å·çš„ section å­—æ®µåˆ¤æ–­å…¶ä½ç½®:
>   - ".text" - ä»£ç æ®µ
>   - ".data" - æ•°æ®æ®µ
>   - ".bss" - BSSæ®µ
>   - "" (empty) - æœªå®šä¹‰ç¬¦å·

å®Œæˆåï¼Œè¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_1
```

## ä»»åŠ¡äºŒï¼šå®ç°åŸºç¡€é“¾æ¥å™¨

### ç¤ºä¾‹

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ç†è§£é“¾æ¥å™¨çš„å·¥ä½œåŸç†ã€‚å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªç¨‹åºï¼š

```c
// foo.c
const char str[] = "Hello, World!";  // ä¸€ä¸ªå…¨å±€å­—ç¬¦ä¸²å¸¸é‡

// main.c
extern const char str[];  // å£°æ˜ï¼šstr åœ¨åˆ«å¤„å®šä¹‰

void _start()
{
    int ans = 0;
    for (int i = 0; i < 10; i++) {
        ans += str[i];  // éœ€è¦æ‰¾åˆ° str çš„å®é™…ä½ç½®
    }
    // ... é€€å‡ºç³»ç»Ÿè°ƒç”¨ ...
}
```

ç¼–è¯‘å™¨ä¼šå°†è¿™äº›æºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚

å¤ä¹ ä¸‹[ä»»åŠ¡é›¶](#ä»»åŠ¡é›¶ç†è§£ç›®æ ‡æ–‡ä»¶æ ¼å¼)çš„å†…å®¹ï¼šæˆ‘ä»¬æœ‰ä¸¤ç§ç­‰ä»·æ–¹å¼æ¥è¡¨è¾¾è¿™ä¸ªç›®æ ‡æ–‡ä»¶ï¼Œä¸€ç§æ˜¯ç£ç›˜ä¸Šçš„ FLE æ ¼å¼æ–‡ä»¶ï¼Œä¸€ç§æ˜¯å†…å­˜ä¸­çš„ `FLEObject` ç»“æ„ä½“ã€‚

ä»¥ `foo.fle` ä¸ºä¾‹ï¼Œå®ƒåœ¨ç£ç›˜ä¸Šçš„æ ¼å¼æ–‡ä»¶æ˜¯ï¼š

```json5
{
    "type": ".obj",
    "shdrs": [ /* ... èŠ‚å¤´ï¼ˆç•¥ï¼‰ ... */ ],
    ".text": [],
    ".rodata": [
        "ğŸ“¤: str 14 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· strï¼Œå¤§å°ä¸º 14 å­—èŠ‚
        "ğŸ”¢: 48 65 6c 6c 6f 2c 20 57 6f 72 6c 64 21 00"   // "Hello, World!"çš„å­—èŠ‚è¡¨ç¤º
    ]
}
```

å½“è¿™ä¸ªæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œå®ƒä¼šè¢«è§£ææˆä¸€ä¸ª `FLEObject` ç»“æ„ã€‚å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œå…¶ä¸­çš„ `symbols` æˆå‘˜æ˜¯ä¸€ç³»åˆ— `Symbol` ç»“æ„çš„åˆ—è¡¨ï¼Œæ¯ä¸ª `Symbol` ç»“æ„å­˜å‚¨ç€ç¬¦å·åŠå…¶å®šä¹‰ä½ç½®çš„ä¿¡æ¯ã€‚åœ¨ä¸Šä¾‹ä¸­ï¼Œå‡è®¾æˆ‘ä»¬ç”¨ `obj` æ¥è¡¨ç¤ºè¿™ä¸ª `FLEObject`ï¼Œé‚£ä¹ˆ `obj.symbols[0]` æ˜¯ï¼š

```cpp
Symbol {
    .type = SymbolType::GLOBAL,  // å¯¹åº”æ–‡ä»¶ä¸­çš„ ğŸ“¤
    .section = ".rodata",        // ç¬¦å·æ‰€åœ¨çš„èŠ‚æ˜¯åªè¯»æ•°æ®æ®µ
    .offset = 0,                 // åœ¨èŠ‚å†…çš„åç§»
    .size = 14,                  // ç¬¦å·å¤§å°ä¸º 14 å­—èŠ‚
    .name = "str"                // ç¬¦å·åç§°
}
```

å®ƒæœ¬è´¨ä¸Šæ˜¯åœ¨è¯´ï¼Œç¬¦å· `str` å¯¹åº”é‚£ä¹ˆä¸€ä¸ªæŒ‡å‘ `.rodata+0` è‡³ `.rodata+14` çš„â€œæŒ‡é’ˆâ€ã€‚

è¿™ä¸ª `FLEObject` ä¸­ï¼Œè¿˜æœ‰ä¸ª `sections` æˆå‘˜ï¼Œæ˜¯ä¸€ç³»åˆ— `FLESection` ç»“æ„çš„åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªå¯¹åº” `.rodata` èŠ‚çš„ `FLESection` å¯¹è±¡ï¼Œå³ `obj.sections[".rodata"]`ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº† `Symbol` å¯¹è±¡ `str` æ‰€æŒ‡å‘çš„å…·ä½“å†…å®¹ï¼Œ

```cpp
FLESection {
    .data = { 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x57, 
              0x6f, 0x72, 0x6c, 0x64, 0x21, 0x00 }  // "Hello, World!"
}
```

ä»¥ä¸Šæ˜¯ `foo.fle` ç›®æ ‡æ–‡ä»¶çš„ä¸¤ç§è¡¨ç¤ºï¼›ç±»ä¼¼åœ°ï¼Œå¯¹äº `main.fle`ï¼Œå…¶ç£ç›˜ä¸Šçš„æ ¼å¼æ–‡ä»¶ä¸ºï¼š

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: _start 63 0",    // å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å· _start
        "ğŸ”¢: 55 48 89 e5 c7 45 fc 00 00 00 00 c7 45 f8 00 00",  // æœºå™¨ç 
        "ğŸ”¢: 00 00 eb 16 8b 45 f8 48 98 0f b6 80",
        "â“: .abs32s(str + 0)",  // éœ€è¦é‡å®šä½ï¼šå¡«å…¥ str çš„åœ°å€
        "ğŸ”¢: 0f be c0 01 45 fc 83 45 f8 01 83 7d f8 09 7e e4",
        "ğŸ”¢: 8b 55 fc 89 d7 b8 3c 00 00 00 0f 05 90 5d c3"
    ]
}
```

åŒæ ·ï¼Œåœ¨ `FLEObject` ä¸­ï¼Œæ¯ä¸ª `FLESection` å¯¹è±¡éƒ½è¿›ä¸€æ­¥æœ‰ä¸€ä¸ª `relocations` æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ç³»åˆ— `Relocation` ç»“æ„çš„åˆ—è¡¨ã€‚æ¯”å¦‚ï¼Œ
`obj.sections[".text"].relocations[0]` æ˜¯ï¼š

```cpp
Relocation {
    .type = RelocationType::R_X86_64_32S,  // 32ä½æœ‰ç¬¦å·ç»å¯¹å¯»å€
    .offset = 28,                          // é‡å®šä½åœ¨èŠ‚å†…çš„ä½ç½®
    .symbol = "str",                       // ç›®æ ‡ç¬¦å·
    .addend = 0                            // åç§»é‡
}
```

è¿™æœ¬è´¨ä¸Šæ˜¯åœ¨è¯´ï¼Œæœ‰é‚£ä¹ˆä¸€ä¸ªæŒ‡å‘ `.text+28` è‡³ `.text+32` çš„â€œæŒ‡é’ˆâ€ï¼Œå…¶å€¼éœ€è¦è¢«ä¿®æ­£ä¸ºç¬¦å· `str` çš„åœ°å€ã€‚

### é“¾æ¥è¿‡ç¨‹

[é“¾æ¥å™¨](#ä»€ä¹ˆæ˜¯é“¾æ¥)åªåšä¸‰ä»¶äº‹ï¼šå¸ƒå±€è§„åˆ’ï¼ç¬¦å·è§£æï¼é‡å®šä½ï¼

æœ€åè¿˜è¦ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚

#### å¸ƒå±€è§„åˆ’

é¦–å…ˆï¼Œé“¾æ¥å™¨å°†å„ä¸ªç›®æ ‡æ–‡ä»¶ä¸­çš„ç›¸åŒèŠ‚ï¼ˆ`.text`ã€`.rodata` ç­‰ï¼‰åˆå¹¶ï¼Œå½¢æˆä¸€ä¸ªæœ€ç»ˆçš„å†…å­˜å¸ƒå±€ã€‚

> [!TIP]
> åœ¨æœ¬ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥å…ˆé€‰æ‹©ç®€å•åœ°å°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶çš„æ‰€æœ‰èŠ‚éƒ½æŒ‰é¡ºåºåˆå¹¶åˆ°ä¸€ä¸ª `.load` èŠ‚ä¸­ï¼Œè€Œä¸æ˜¯ç”Ÿæˆ `.text`ã€`.rodata` ç­‰èŠ‚ã€å¹¶èµ‹äºˆå®ƒä»¬ä¸åŒçš„æƒé™ â€”â€” èŠ‚åˆ†ç¦»æ˜¯[ä»»åŠ¡å…­](#ä»»åŠ¡å…­åˆ†ç¦»ä»£ç å’Œæ•°æ®)çš„å†…å®¹ã€‚

#### ç¬¦å·è§£æ

åœ¨èŠ‚åˆå¹¶åï¼Œé“¾æ¥å™¨éœ€è¦æ‰¾åˆ°æ¯ä¸ªç¬¦å·çš„å®šä¹‰ï¼ŒæŠŠæ¯ä¸ªç¬¦å·å…³è”åˆ°åˆå¹¶åçš„å†…å­˜å¸ƒå±€ä¸­ã€‚ä¹Ÿå°±æ˜¯è®°å½•ä¸‹æ¯ä¸ªç¬¦å·éƒ½å»äº†å“ªé‡Œï¼Œè¿™æ ·ä½ åœ¨é‡å®šä½æ—¶æ‰èƒ½æ‰¾åˆ°å®ƒã€‚

> [!TIP]
> ä½ å¯ä»¥ç”¨ `0x400000` ä½œä¸ºç¨‹åºçš„åŸºå€ï¼Œæ„æ€æ˜¯ï¼Œ`.load` æ®µåœ¨è¿è¡Œæ—¶å°†è¢«åŠ è½½åˆ° `0x400000`ã€‚
> 
> è¿™æ ·ï¼Œå¦‚æœä½ å·²ç»æŠŠ `main.fle` ä¸­å¤§å°ä¸º `47` çš„ `.text` èŠ‚åˆå¹¶è¿› `.load` æ®µäº†ï¼Œæ¥ä¸‹æ¥ä½ è¦åˆå¹¶ `foo.fle` çš„ `.data` èŠ‚ï¼Œè¿™ä¸ªèŠ‚åœ¨è¿è¡Œæ—¶çš„èµ·å§‹åœ°å€å°±åº”è¯¥æ˜¯ `0x40003F`ã€‚ä»è€Œï¼Œåœ¨è¿™ä¸ªèŠ‚ä¸­å®šä¹‰çš„ `offset` ä¸º `0` çš„ç¬¦å· `str` çš„åœ°å€ä¸º `0x40003F`ã€‚

> [!TIP]
> ä½ å¯ä»¥è¾¹åˆå¹¶èŠ‚ï¼Œè¾¹åšç¬¦å·è§£æã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥åˆå¹¶å®ŒæŸä¸ªç›®æ ‡æ–‡ä»¶çš„æŸä¸ªèŠ‚åï¼Œæ‰¾åˆ°åœ¨è¿™ä¸ªèŠ‚ä¸­å®šä¹‰çš„ç¬¦å·ï¼ŒæŠŠæ¯ä¸ªç¬¦å·çš„ `offset` å­—æ®µï¼Œè®¾ç½®ä¸ºå®ƒåœ¨åˆå¹¶åçš„æ–°ä½ç½®ï¼Œå¹¶æŠŠæ¯ä¸ªæ›´æ–°åçš„ `Symbol` éƒ½åŠ å…¥åˆ°å…¨å±€ç¬¦å·è¡¨ä¸­ã€‚

> [!IMPORTANT]
> åœ¨å¤„ç†ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨æ—¶ï¼Œä½ ä¼šå‘ç°å•ä¸ªç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­å¯èƒ½åŒ…å«æœªå®šä¹‰ç¬¦å·ï¼ˆå³åœ¨å½“å‰æ–‡ä»¶ä¸­è¢«å¼•ç”¨ä½†å°šæœªå®šä¹‰çš„ç¬¦å·ï¼‰ã€‚è¿™ä¸æ ‡å‡† ELF æ ¼å¼çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚å¤„ç†è¿™äº›ç¬¦å·æ—¶ï¼š
> - ä¸è¦ç«‹å³æŠ¥å‘Šæœªå®šä¹‰é”™è¯¯
> - åœ¨åç»­çš„ç›®æ ‡æ–‡ä»¶ä¸­ç»§ç»­æŸ¥æ‰¾è¯¥ç¬¦å·çš„å®šä¹‰
> - åªæœ‰åœ¨å¤„ç†å®Œæ‰€æœ‰ç›®æ ‡æ–‡ä»¶åï¼Œä»ç„¶æ‰¾ä¸åˆ°å®šä¹‰æ—¶æ‰æŠ¥é”™
>
> è¿™ç§æœºåˆ¶å…è®¸ç›®æ ‡æ–‡ä»¶ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œä¸è¦æ±‚ç¬¦å·å®šä¹‰å¿…é¡»å‡ºç°åœ¨å¼•ç”¨ä¹‹å‰ã€‚


#### é‡å®šä½

å¾—åˆ°å…¨å±€ç¬¦å·è¡¨åï¼Œé“¾æ¥å™¨éœ€è¦éå†æ‰€æœ‰çš„é‡å®šä½é¡¹ï¼Œæ ¹æ®é‡å®šä½é¡¹çš„ç±»å‹ï¼Œè®¡ç®—è¦å¡«å…¥çš„å€¼ï¼Œæ›´æ–°é‡å®šä½é¡¹æ‰€æŒ‡å‘çš„åœ°å€å¼•ç”¨ã€‚

> [!TIP]
> é‡å®šä½ç±»å‹å†³å®šäº†å¦‚ä½•è®¡ç®—è¦å¡«å…¥çš„å€¼ã€‚
> 
> åœ¨æœ¬ä»»åŠ¡ä¸­ï¼Œä½ åªéœ€è¦å¤„ç† `R_X86_64_32` å’Œ `R_X86_64_32S` ç±»å‹çš„é‡å®šä½ â€”â€” å®ƒä»¬éƒ½æ˜¯ç›´æ¥å°†ç¬¦å·çš„ç»å¯¹åœ°å€å¡«å…¥é‡å®šä½ä½ç½®ï¼Œå³**ç»å¯¹é‡å®šä½**ã€‚

> [!NOTE]
> `R_X86_64_32` å’Œ `R_X86_64_32S` éƒ½ä¼šå°† 64 ä½åœ°å€æˆªæ–­ä¸º 32 ä½ï¼ŒåŒºåˆ«åœ¨äºé“¾æ¥å™¨å¦‚ä½•éªŒè¯è¿™ä¸ªæˆªæ–­æ˜¯å¦åˆæ³•ï¼š
> - `R_X86_64_32`ï¼šè¦æ±‚æˆªæ–­æ‰çš„é«˜ 32 ä½å¿…é¡»ä¸º 0ï¼Œè¿™æ ·é€šè¿‡é›¶æ‰©å±•å¯ä»¥è¿˜åŸå‡ºåŸå§‹çš„ 64 ä½å€¼
> - `R_X86_64_32S`ï¼šè¦æ±‚é«˜ 32 ä½çš„å€¼ä¸æˆªæ–­åçš„ç¬¦å·ä½ï¼ˆå³ç¬¬ 32 ä½ï¼‰ç›¸åŒï¼ˆå…¨ 0 æˆ–å…¨ 1ï¼‰ï¼Œè¿™æ ·æ‰èƒ½é€šè¿‡ç¬¦å·æ‰©å±•è¿˜åŸå‡ºåŸå§‹çš„ 64 ä½å€¼
>
> ä½ å¯ä»¥ç®€å•å¿½ç•¥å®ƒä»¬çš„åŒºåˆ«ã€‚

ä»ä»¥ä¸Šè¿°çš„ `main.fle` ä¸ºä¾‹ï¼Œå¯¹äºé‡å®šä½é¡¹ `â“: .abs32s(str + 0)`ï¼Œç±»å‹ä¸º `R_X86_64_32S`ï¼Œä»£è¡¨ `text+28` è‡³ `text+32` è¿™æ®µç©ºé—´çš„å€¼éœ€è¦è¢«ä¿®æ­£ä¸º `str` çš„åœ°å€ï¼ˆè¿™é‡Œçš„ `+ 0` æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œé™„åŠ å€¼ä¸é€‚ç”¨äºç»å¯¹é‡å®šä½ï¼‰ï¼Œé“¾æ¥å™¨éœ€è¦ï¼š
1. åœ¨åˆå¹¶åçš„å…¨å±€ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾ `str` ç¬¦å·ï¼Œè·å–ç¬¦å·åœ°å€ `0x40003F`
2. è®¡ç®—è¦å¡«å…¥çš„å€¼
    - å¯¹äº `R_X86_64_32S` é‡å®šä½ç±»å‹ï¼Œå³ç›´æ¥æˆªæ–­ç¬¦å·åœ°å€çš„ä½ 32 ä½
    $$
    \text{æœ€ç»ˆå€¼} = \text{ç¬¦å·åœ°å€} \mathbin{\\&} 0xFFFFFFFF = 0x40003F \mathbin{\\&} 0xFFFFFFFF = 0x40003F
    $$
    - éªŒè¯ï¼šè¿™ä¸ªæˆªæ–­åçš„å€¼æ˜¯åˆæ³•çš„ï¼Œé€šè¿‡é›¶æ‰©å±•å¯ä»¥è¿˜åŸå‡ºåŸå§‹çš„ 64 ä½å€¼
3. å°† `0x40003F` å¡«å…¥ `text+28` è‡³ `text+32` è¿™æ®µç©ºé—´ï¼Œå¾—åˆ° `80 3F 00 40 00`ã€‚

// TODO: éªŒè¯ä¸‹å¯¹å—ï¼Ÿ

> [!TIP]
> - æ³¨æ„å­—èŠ‚åºçš„é—®é¢˜ã€‚x86-64 ä½¿ç”¨å°ç«¯åºã€‚
> - æ³¨æ„è¦åŠ ä¸Š `0x40000` ä½œä¸ºåŸºåœ°å€ã€‚

// åŸºåœ°å€æ˜¯è¿™ä¸ªå—ï¼Ÿå¯ä¸å¯ä»¥æ”¾fle.hppé‡Œ

#### å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆ

æœ€åï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¡«å†™æ–‡ä»¶å¤´ã€æ®µä¿¡æ¯ç­‰ã€‚

åœ¨æˆ‘ä»¬çš„æ¡†æ¶ä¸‹ï¼Œé“¾æ¥å™¨éœ€è¦åˆ›å»ºä¸€ä¸ª `.type == ".exe"` çš„ `FLEObject`ã€‚å…¶ `.name` å­—æ®µå¯è®¾ç½®ä¸ºä»»æ„å­—ç¬¦ä¸²ï¼ˆå¦‚ `"a.out"`ï¼‰ï¼›`.phdrs` å­—æ®µéœ€è¦è®¾ç½®ä¸ºä¸€ä¸ªæ­£ç¡®çš„ `ProgramHeader` ç»“æ„ï¼Œä»¥ä¾¿åŠ è½½å™¨èƒ½å¤Ÿæ­£ç¡®åœ°åŠ è½½ç¨‹åºã€‚

> [!NOTE]
> åŠ è½½å™¨ï¼ˆloaderï¼‰æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£æŠŠå¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ˆæ¯”å¦‚åˆ†é…ç©ºé—´ã€å»ºç«‹æ˜ å°„å…³ç³»ï¼‰ï¼Œå¹¶åˆå§‹åŒ–ç¨‹åºçš„æ‰§è¡Œç¯å¢ƒï¼ˆæ¯”å¦‚åˆå§‹åŒ–æ ˆç©ºé—´ã€è·³è½¬åˆ°ç¨‹åºå…¥å£ç‚¹ï¼‰ã€‚
> 
> æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç”¨æˆ·æ€çš„åŠ è½½å™¨ï¼Œæ¨¡æ‹Ÿæ“ä½œç³»ç»ŸåŠ è½½å™¨çš„è¡Œä¸ºã€‚é€šè¿‡ `./exec` å‘½ä»¤ï¼Œä½ å¯ä»¥åŠ è½½è¿è¡Œä¸€ä¸ª FLE æ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
> 
> ä½ å°†åœ¨ä¸‹å­¦æœŸ ICS 2 è¯¾ç¨‹ä¸­å­¦åˆ°æœ‰å…³åŠ è½½å™¨çš„æ›´å¤šçŸ¥è¯†ã€‚

> [!TIP]
> ä¸Šé¢æåˆ°ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªä»»åŠ¡ä¸­å¯ä»¥æŠŠæ‰€æœ‰èŠ‚ä¸€è‚¡è„‘åœ°æ‰”è¿› `.load` æ®µé‡Œã€‚æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªç¨‹åºå¤´æ¥æè¿°è¿™ä¸ªæ®µï¼Œä½ å¯ä»¥ç›´æ¥å‚è€ƒä¸‹é¢è¿™æ®µä»£ç ï¼š
> ```cpp
> ProgramHeader header = {
>     .name = ".load", // æè¿°çš„æ˜¯ .load æ®µ
>     .vaddr = 0x400000, // æˆ‘ä»¬ä½¿ç”¨å›ºå®šçš„åŠ è½½åœ°å€ 0x400000
>     .size = size, // åˆå¹¶åçš„æ€»å¤§å°
>     .flags = PHF::R | PHF::W | PHF::X // å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼Œç®€å•åœ°èµ‹äºˆæ‰€æœ‰æƒé™
> };
> ```

æ­¤å¤–ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¿…é¡»æŒ‡å®šä¸€ä¸ªå…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºå¼€å§‹æ‰§è¡Œçš„ä½ç½®ã€‚
æŒ‰æƒ¯ä¾‹ï¼Œåœ¨åŸºäº C è¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œè¿™ä¸ªå…¥å£ç‚¹é€šå¸¸æ˜¯åä¸º `_start` çš„å‡½æ•°ã€‚é“¾æ¥å™¨éœ€è¦åœ¨åˆå¹¶çš„å…¨å±€ç¬¦å·è¡¨ä¸­æ‰¾åˆ° `_start` ç¬¦å·ï¼Œå¹¶å°†å…¶åœ°å€ï¼ˆåŸºåœ°å€ + ç¬¦å·åç§»ï¼‰è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ç‚¹ã€‚

åœ¨å®Œæˆè¿™äº›å·¥ä½œåï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„ `FLEObject` ç»“æ„ä½“ï¼Œä¸ºåŠ è½½å™¨æè¿°äº†æ•´ä¸ªç¨‹åºç†åº”è¾¾æˆçš„å†…å­˜å¸ƒå±€ã€‚`FLE_ld` å‡½æ•°åªéœ€è¿”å›è¿™ä¸ªç»“æ„ä½“ï¼Œæˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¼šå°†å…¶åºåˆ—åŒ–ä¸º FLE æ ¼å¼æ–‡ä»¶ï¼š

```json5
{
    "type": ".exe",           // è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
    "phdrs": [
        {
            "name": ".load",  // ç¨‹åºå¤´
            "vaddr": 4194304, // å›ºå®šçš„åŠ è½½åœ°å€ 0x400000
            "size": 19,       // åˆå¹¶åçš„æ€»å¤§å°
            "flags": 7        // å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œ
        }
    ],
    ".load": [                // åˆå¹¶åçš„èŠ‚å†…å®¹ï¼ŒåªåŒ…å«æœºå™¨ç 
        "ğŸ”¢: 55 48 89 e5 bf 64 00 00 00 b8 3c 00 00 00 0f 05 ",
        "ğŸ”¢: 90 5d c3 "
    ],
    "entry": 4194304          // ç¨‹åºçš„å…¥å£ç‚¹ 0x400000 çš„åè¿›åˆ¶è¡¨ç¤º
}
```

// TODO: æ€ä¹ˆ.loadæ²¡äº†

è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

> [!TIP]
> åœ¨å®ç°é“¾æ¥å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ç§å¯è¡Œçš„æ€è·¯æ˜¯é‡‡ç”¨å¤šéæ‰«æçš„æ–¹æ³•ï¼š
> 1. ç¬¬ä¸€æ¬¡æ‰«æï¼šåˆå¹¶æ‰€æœ‰èŠ‚çš„å†…å®¹
> 2. ç¬¬äºŒæ¬¡æ‰«æï¼šæ”¶é›†å¹¶è§£ææ‰€æœ‰ç¬¦å·
> 3. ç¬¬ä¸‰æ¬¡æ‰«æï¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡å¤„ç†æ‰€æœ‰é‡å®šä½é¡¹ï¼Œå°†è®¡ç®—å‡ºçš„åœ°å€å›å¡«
> 
> æœ€åç”Ÿæˆç¨‹åºå¤´ï¼Œå¹¶è®¾ç½®å…¥å£ç‚¹ï¼Œå¾—åˆ°æœ€ç»ˆçš„ `FLEObject`ã€‚
> 
> å¯ä»¥æ€è€ƒï¼šä¸ºä»€ä¹ˆè¦é‡‡å–è¿™æ ·çš„æ‰«æé¡ºåºï¼Ÿæœ‰æ²¡æœ‰å…¶ä»–æ›´å¥½çš„æ–¹æ³•ï¼Ÿ

è¯·åœ¨ [`src/student/ld.cpp`](/src/student/ld.cpp) ä¸­å®ç°ä½ çš„é“¾æ¥å™¨ã€‚

> [!TIP]
> Start simple, move fast!
> åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥å…ˆå¤„ç†åªæœ‰ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç®€å•æƒ…å½¢ã€‚ä½¿ç”¨ `readfle` å·¥å…·æ£€æŸ¥è¾“å‡ºæ–‡ä»¶çš„æ ¼å¼æ˜¯å¦æ­£ç¡®å¹¶æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆæ¯”å¦‚èŠ‚çš„åˆå¹¶è¿‡ç¨‹ã€ç¬¦å·çš„æ–°åœ°å€ã€é‡å®šä½çš„å¤„ç†è¿‡ç¨‹ï¼‰ä¹Ÿä¼šå¯¹è°ƒè¯•å¾ˆæœ‰å¸®åŠ©ã€‚

å®Œæˆåï¼Œä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•é“¾æ¥å™¨çš„åŸºç¡€åŠŸèƒ½ï¼š

```bash
make test_2
```

## ä»»åŠ¡ä¸‰ï¼šå®ç°ç›¸å¯¹é‡å®šä½

åœ¨ä»»åŠ¡äºŒä¸­ï¼Œæˆ‘ä»¬å¤„ç†äº†ç»å¯¹é‡å®šä½ â€”â€” è®¿é—®å…¨å±€å˜é‡æ—¶ä½¿ç”¨ç»å¯¹åœ°å€æ‰€éœ€è¦çš„é‡å®šä½ã€‚å‡½æ•°è°ƒç”¨åˆ™æœ‰æ‰€ä¸åŒï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨æ±‡ç¼–ä¸€ç« æ‰€å­¦åˆ°çš„ï¼Œå¯¹åº”æ±‡ç¼–çº§åˆ«çš„ç›¸å¯¹è·³è½¬ï¼Œåœ¨é“¾æ¥æ—¶åˆ™éœ€è¦åš**ç›¸å¯¹é‡å®šä½**ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š
```c
// lib.c
int add(int x) {    // ä¸€ä¸ªç®€å•çš„å‡½æ•°
    return x + 1;
}

// main.c
extern int add(int);  // å£°æ˜ï¼šadd å‡½æ•°åœ¨åˆ«å¤„å®šä¹‰

int main() {
    return add(41);   // è°ƒç”¨ add å‡½æ•°
}
```

ç¼–è¯‘å™¨ä¼šå°†è¿™äº›æºæ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ã€‚è¿™ä¸ªå‡½æ•°è°ƒç”¨åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œè¡¨ç¤ºä¸º:

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“¤: main 20 0",
        "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 bf 29 00 00 00 e8",
        "â“: .rel(add - 4)",  // é“¾æ¥å™¨éœ€è¦å°†è¿™é‡Œæ›¿æ¢æˆ call æŒ‡ä»¤çš„ç›®æ ‡åœ°å€ï¼ˆå››å­—èŠ‚ï¼‰
        "ğŸ”¢: 5d c3"
    ]
}
```

> [!TIP]
> x86-64 çš„ call æŒ‡ä»¤æ ¼å¼æ˜¯ï¼š
> - ä¸€ä¸ªå­—èŠ‚çš„æ“ä½œç ï¼ˆ`0xE8`ï¼‰
> - å››ä¸ªå­—èŠ‚çš„ç›¸å¯¹åç§»é‡ï¼ˆå°ç«¯åºï¼‰

å¯¹åº”çš„ `Relocation` ç»“æ„ä½“ï¼š

```cpp
Relocation {
    .type = RelocationType::R_X86_64_PC32,  // 32ä½ç›¸å¯¹å¯»å€
    .offset = 14,                           // é‡å®šä½ä½ç½®ï¼ˆåœ¨èŠ‚å†…çš„åç§»ï¼‰
    .symbol = "add",                        // ç›®æ ‡ç¬¦å·
    .addend = -4                            // åç§»é‡è°ƒæ•´å€¼
}
```

è¿˜è®°å¾— [FLE æ ¼å¼æ–‡ä»¶](#ä»»åŠ¡é›¶ç†è§£ç›®æ ‡æ–‡ä»¶æ ¼å¼)çš„çº¦å®šå—ï¼Ÿè¿™é‡Œ `.rel(add - 4)` è¡¨ç¤ºä¸€ä¸ªç›¸å¯¹é‡å®šä½ï¼ˆ`R_X86_64_PC32` ç±»å‹ï¼‰ï¼Œå…¶ç›®æ ‡ç¬¦å·æ˜¯ `add`ï¼Œé™„åŠ å€¼ä¸º `-4`ã€‚ä¸ä»»åŠ¡äºŒä¸­çš„ç»å¯¹é‡å®šä½ä¸åŒï¼Œè¿™é‡Œå­˜å‚¨çš„ä¸æ˜¯å‡½æ•°çš„ç»å¯¹åœ°å€ï¼Œè€Œæ˜¯â€œè¦è·³å¤šè¿œâ€ã€‚è¿™ç§è®¾è®¡æœ‰ä¸¤ä¸ªé‡è¦çš„ä¼˜ç‚¹ï¼š
1. ä»£ç å¯ä»¥åŠ è½½åˆ°å†…å­˜çš„ä»»ä½•ä½ç½®ï¼ˆå¤©ç„¶æ”¯æŒä½ç½®æ— å…³ï¼Œè€Œä¸éœ€è¦åŠ¨æ€é“¾æ¥å™¨è¿è¡Œæ—¶ä¿®æ­£åœ°å€ï¼‰
2. è·³è½¬æŒ‡ä»¤æ›´çŸ­ï¼ˆä»£ç ä½“ç§¯åªè¦ä¸è¶…è¿‡ 4GBï¼Œå°±åªéœ€è¦ 32 ä½åç§»é‡ï¼‰

è®¡ç®—å…¬å¼éå¸¸ç®€å•ï¼š

$$
\text{åç§»é‡} = S + A - P
$$

å…¶ä¸­ï¼š
- S (Symbol)ï¼šç›®æ ‡ç¬¦å·çš„åœ°å€ï¼ˆæ¯”å¦‚ `add` å‡½æ•°çš„ä½ç½®ï¼‰
- A (Addend)ï¼šé‡å®šä½é¡¹ä¸­çš„é™„åŠ å€¼ï¼ˆè¿™å°±æ˜¯ `- 4` æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ï¼ï¼‰
- P (Place)ï¼šé‡å®šä½ä½ç½®çš„åœ°å€ï¼ˆ`call` æŒ‡ä»¤æ“ä½œæ•°çš„ä½ç½®ï¼‰

æ¯”å¦‚ï¼Œå¦‚æœï¼š
- add å‡½æ•°åœ¨ 0x4000A0
- call æŒ‡ä»¤çš„æ“ä½œæ•°åœ¨ 0x400035
- é™„åŠ å€¼æ˜¯ -4

é‚£ä¹ˆï¼š
$$
\text{åç§»é‡} = 0x4000A0 + (-4) - 0x400035 = 0x67
$$

æœ€ç»ˆçš„æœºå™¨ç å°±æ˜¯ï¼š
```
e8 67 00 00 00   ; call add
```

> [!NOTE]
> ä¸ºä»€ä¹ˆéœ€è¦ `addend`ï¼ˆé™„åŠ å€¼ï¼‰ï¼Ÿè¿™ä¸ x86-64 çš„ç¨‹åºè®¡æ•°å™¨ `%rip` çš„å·¥ä½œæ–¹å¼æœ‰å…³ï¼š
> ```
>   X:  E8          ; call rel32 çš„æ“ä½œç  (1 Byte)
> X+1:  ?? ?? ?? ?? ; 32 ä½åç§»é‡ (4 Bytes)
> X+5:  ?? ?? ?? ?? ; ä¸‹ä¸€æ¡æŒ‡ä»¤
> ```
> 1. call æŒ‡ä»¤ä¸­çš„åç§»é‡æ˜¯ç›¸å¯¹äºç¨‹åºè®¡æ•°å™¨ `%rip` çš„ï¼Œè€Œåœ¨å½“å‰æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œ`%rip` å·²ç»æŒ‡å‘äº†ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ $X+5$
> 2. æ‰€ä»¥å½“ CPU æ‰§è¡Œåˆ°è¿™ä¸ª call æŒ‡ä»¤æ—¶ï¼Œå®é™…éœ€è¦è·³è½¬çš„è·ç¦»æ˜¯ $\text{åç§»é‡} = S - (X+5)$
> 3. é“¾æ¥æ—¶ï¼Œé‡å®šä½ä½ç½®çš„åœ°å€æ˜¯ $P = X+1$ï¼Œå› æ­¤ï¼Œå¦‚æœå…¬å¼ä¸º $ \text{åç§»é‡} = S + A - P = S + A - (X+1) $ï¼Œä»è€Œå¾—åˆ° $A = -4$ï¼Œå³ `addend` ä¸º -4ã€‚
> 
> ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é‡å®šä½ä½ç½®çš„åœ°å€ï¼Œå’Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å·®ä¸º $-4$ã€‚
>
> ä½ å°†åœ¨ä¸‹ä¸‹å­¦æœŸçš„ è®¡ç®—æœºç³»ç»Ÿå®ç° 1 ä¸­å­¦ä¹ åˆ°æ›´å¤šå…³äº CPU æµæ°´çº¿ä¸æŒ‡ä»¤æ‰§è¡Œçš„çŸ¥è¯†ã€‚

è¯·åœ¨ä½ å®ç°çš„é“¾æ¥å™¨åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥æ”¯æŒç›¸å¯¹é‡å®šä½ã€‚

> [!TIP]
> è°ƒè¯•ç›¸å¯¹é‡å®šä½æ—¶ï¼Œæ‰“å°æ¯ä¸€æ­¥çš„åŸºæœ¬ä¿¡æ¯å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼š
> - ç›®æ ‡ç¬¦å·çš„åœ°å€ï¼ˆSï¼‰
> - é‡å®šä½ä½ç½®çš„åœ°å€ï¼ˆPï¼‰
> - è®¡ç®—å¾—åˆ°çš„åç§»é‡
> - æœ€ç»ˆå†™å…¥çš„å­—èŠ‚

å®Œæˆåï¼Œè¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_3
```

> [!NOTE]
> æˆ‘ä»¬åœ¨è¿™é‡Œè§£é‡Šä¸Šä¸€èŠ‚ä¸­ï¼Œä¸ºä»€ä¹ˆå…¥å£ç‚¹æ€»æ˜¯åä¸º `_start` çš„å‡½æ•°ã€‚
> 
> C ä¸ C++ ç¼–è¯‘å™¨åœ¨é“¾æ¥æ—¶ä¼šé»˜è®¤å°† `libc`ï¼Œå³ C è¯­è¨€æ ‡å‡†åº“é“¾æ¥è¿›æ¥ï¼Œå…¶æœ€å¸¸è§çš„å®ç°æ˜¯ `glibc`ã€‚
> 
> è¿™ä¸ªåº“ä¼šå®šä¹‰ä¸€ä¸ª `_start` å‡½æ•°ï¼Œä½œä¸ºç¨‹åºçš„ä½çº§å…¥å£ç‚¹ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£ä»æ ˆä¸Šè§£æå‘½ä»¤è¡Œå‚æ•°ã€åˆå§‹åŒ– C++ å…¨å±€å¯¹è±¡ã€åˆå§‹åŒ–å †å†…å­˜ç®¡ç†ç­‰ï¼Œå¹¶è¿›ä¸€æ­¥è°ƒç”¨ `main` å‡½æ•°ï¼Œè½¬ç§»æ§åˆ¶æƒã€‚
>
> å…¶ä»–è¯­è¨€ï¼Œå¦‚ Goã€Rust ç­‰ï¼Œäº¦æœ‰ç±»ä¼¼çš„æœºåˆ¶ã€‚
>
> ä»ä»»åŠ¡ä¸‰å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åŒ…å« [`tests/common/minilibc.h`](./tests/common/minilibc.h)ï¼Œè¿™ä¸ªåº“æ¨¡æ‹Ÿäº† `libc` çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œæä¾›é¢„å®šä¹‰çš„ `_start` å‡½æ•°ã€‚

## ä»»åŠ¡å››ï¼šå¤„ç†ç¬¦å·å†²çªå’Œå±€éƒ¨ç¬¦å·

åœ¨å‰é¢çš„ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªç¬¦å·åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ã€‚ä½†åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°**åŒåç¬¦å·**ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```c
// config.c
int debug_level = 0;  // é»˜è®¤é…ç½®

// main.c
int debug_level = 1;  // è‡ªå®šä¹‰é…ç½®
```

è¿™æ—¶é“¾æ¥å™¨è¯¥æ€ä¹ˆåŠï¼Ÿåº”è¯¥ç”¨å“ªä¸ª `debug_level`ï¼Ÿ

é™¤äº†å¤„ç†åŒåç¬¦å·çš„é—®é¢˜ï¼Œé“¾æ¥å™¨è¿˜éœ€è¦æ­£ç¡®å¤„ç†ç¬¦å·çš„å¯è§æ€§ã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `static` å…³é”®å­—å°†ç¬¦å·å£°æ˜ä¸ºå±€éƒ¨çš„ï¼š

```c
// foo.c
static int counter = 0;  // å±€éƒ¨ç¬¦å·ï¼Œåªåœ¨æœ¬æ–‡ä»¶å¯è§

// main.c
extern int counter;      // é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¬¦å· counter
```

è¿™ç§æƒ…å†µåº”è¯¥åœ¨é“¾æ¥æ—¶è¢«å‘ç°å¹¶æŠ¥é”™ã€‚å› ä¸ºå¯¹äº `main.c` æ¥è¯´ï¼Œ`foo.c` ä¸­çš„å±€éƒ¨ç¬¦å· `counter` ç›¸å½“äºæœªå®šä¹‰ç¬¦å· â€”â€” å®ƒæ ¹æœ¬å°±â€œçœ‹ä¸åˆ°â€è¿™ä¸ªç¬¦å·ã€‚

ä¸ºäº†è§£å†³ç¬¦å·å†²çªå’Œå¯è§æ€§é—®é¢˜ï¼ŒC è¯­è¨€æä¾›äº†å‡ ç§ä¸åŒâ€œå¼ºåº¦â€çš„ç¬¦å·ï¼š

- å¼ºç¬¦å·ï¼ˆGLOBALï¼‰ï¼šæ™®é€šçš„å…¨å±€ç¬¦å·
- å¼±ç¬¦å·ï¼ˆWEAKï¼‰ï¼šå¯ä»¥è¢«è¦†ç›–çš„å¤‡é€‰é¡¹
- å±€éƒ¨ç¬¦å·ï¼ˆLOCALï¼‰ï¼šåªåœ¨å®šä¹‰å®ƒçš„ç›®æ ‡æ–‡ä»¶å†…å­˜åœ¨

æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œç”¨å¼±ç¬¦å·æ¥æä¾›å¯è¦†ç›–çš„é»˜è®¤å®ç°ï¼š

```c
// logger.c
__attribute__((weak))        // æ ‡è®°ä¸ºå¼±ç¬¦å·
void init_logger() {         // é»˜è®¤çš„åˆå§‹åŒ–å‡½æ•°
    // ä½¿ç”¨é»˜è®¤é…ç½®
}

// main.c
void init_logger() {         // å¼ºç¬¦å·ä¼šè¦†ç›–é»˜è®¤å®ç°
    // ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
}
```

åœ¨ FLE æ ¼å¼ä¸­ï¼Œå¼±ç¬¦å·ç”¨ ğŸ“ è¡¨ç¤ºï¼š

```json5
{
    "type": ".obj",
    ".text": [
        "ğŸ“: init_logger 20 0",  // å¼±ç¬¦å·
        "ğŸ”¢: 55 48 89 e5 ..."
    ]
}
```

é“¾æ¥æ—¶ï¼Œç¬¦å·å†²çªçš„å¤„ç†è§„åˆ™å¾ˆç®€å•ï¼š

1. å¼ºç¬¦å·å¿…é¡»å”¯ä¸€ï¼Œå¦åˆ™æŠ¥é”™
    ```c
    // a.c
    int max(int x, int y) { return x > y ? x : y; }

    // b.c
    int max(int x, int y) { return x > y ? x : y; }  // é”™è¯¯ï¼šé‡å¤å®šä¹‰ï¼
    ```

2. å¼ºç¬¦å·ä¼˜å…ˆäºå¼±ç¬¦å·
    ```c
    // lib.c
    __attribute__((weak))
    void init() { /* é»˜è®¤å®ç° */ }

    // main.c
    void init() { /* è‡ªå®šä¹‰å®ç°ï¼Œä¼šè¦†ç›–é»˜è®¤ç‰ˆæœ¬ */ }
    ```

3. å¤šä¸ªå¼±ç¬¦å·æ—¶ä»»æ„é€‰æ‹©
    ```c
    // a.c
    __attribute__((weak))
    int debug = 0;

    // b.c
    __attribute__((weak))
    int debug = 1;
    ```

> [!NOTE]
> åœ¨ C++ ä¸­ï¼Œ`inline` å‡½æ•°æˆ–å˜é‡é€šå¸¸è¢«å®ç°ä¸ºå¼±ç¬¦å·ã€‚æ¨¡æ¿ã€å®šä¹‰åœ¨ç±»å†…çš„æˆå‘˜å‡½æ•°ã€`constexpr` å˜é‡æ˜¯éšå¼ `inline` çš„ï¼Œå› æ­¤ä¹Ÿè¢«å®ç°ä¸ºå¼±ç¬¦å·ã€‚
>
> æ€è€ƒä¸€ä¸‹ï¼Œè¿™éƒ½æ˜¯ä¸ºä»€ä¹ˆï¼Ÿæ³¨æ„ C++ çš„ `inline` ä¿®é¥°ç¬¦çš„å«ä¹‰ã€‚

https://arc.net/l/quote/cklcqgdz

https://gcc.gnu.org/onlinedocs/gcc/Vague-Linkage.html

è¯·è®©ä½ çš„é“¾æ¥å™¨æ”¯æŒè¿™äº›è§„åˆ™ï¼Œå¹¶åœ¨è§„åˆ™è¢«è¿åæ—¶è¾“å‡ºåˆç†çš„é”™è¯¯ä¿¡æ¯ï¼š
- å¯¹äºå¼ºç¬¦å·å†²çªçš„æƒ…å½¢ï¼Œåº”å½“è¾“å‡º `"Multiple definition of strong symbol: ${sym.name}`
- å¯¹äºæ‰¾ä¸åˆ°ç¬¦å·å®šä¹‰çš„æƒ…å½¢ï¼Œåº”å½“è¾“å‡º `"Undefined symbol: ${sym.name}`ã€‚

> [!TIP]
> æµ‹è¯•è„šæœ¬é‡‡ç”¨è¾ƒä¸ºå®½æ¾çš„åŒ¹é…æ–¹å¼ï¼Œåªè¦æ£€æµ‹åˆ° `stderr` ä¸­çš„æŸä¸€è¡ŒåŒ…å«ç¬¦åˆæ ¼å¼çš„å­—ç¬¦ä¸²å³è®¤ä¸ºæµ‹è¯•é€šè¿‡ã€‚ä½ å¯ä»¥ï¼š
> - é€šè¿‡ `throw std::runtime_error(err_message)` æŠ›å‡ºå¼‚å¸¸ï¼Œå®éªŒæ¡†æ¶ä¼šè‡ªåŠ¨æ•è·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ ‡å‡†é”™è¯¯æµ
> - ç›´æ¥å‘ `stderr` è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼ˆä½¿ç”¨ `std::cerr` æˆ– `fprintf`ï¼‰ï¼Œç„¶åè°ƒç”¨ `exit(1)` ä¸­æ­¢ç¨‹åº
// å…·ä½“æ˜¯fprintfä»€ä¹ˆ

> [!IMPORTANT]
> åœ¨å®é™…ä»£ç ä¸­ï¼Œé™¤äº†æ˜¾å¼å£°æ˜çš„åŒåå±€éƒ¨ç¬¦å·ä¹‹å¤–ï¼Œä½ è¿˜ä¼šé‡åˆ°ä¸€äº›ç‰¹æ®Šçš„åŒåå±€éƒ¨ç¬¦å·æƒ…å†µã€‚ä¾‹å¦‚ï¼Œå¯¹ä¸åŒæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œç¼–è¯‘å™¨å¯èƒ½ç”ŸæˆåŒåçš„å±€éƒ¨ç¬¦å·ï¼ˆæ¯”å¦‚ `.LC0`ï¼‰ã€‚
> 
> ä¸åŒç›®æ ‡æ–‡ä»¶çš„åŒåå±€éƒ¨ç¬¦å·æ˜¯è¢«å…è®¸çš„ï¼Œå› ä¸ºæ¯ä¸ªå±€éƒ¨ç¬¦å·ä»…åœ¨å½“å‰ç›®æ ‡æ–‡ä»¶ä¸­å¯è§ã€‚

// TODOï¼š åˆ°åº•æ˜¯è¯¥è¯´ å¯è§æ€§ è¿˜æ˜¯ä½œç”¨åŸŸ

> [!TIP]
> ä¸ºäº†å¤„ç†è¿™äº›æƒ…å†µï¼Œä½ éœ€è¦æƒ³åŠæ³•å°†æ¥è‡ªä¸åŒæ–‡ä»¶çš„åŒåå±€éƒ¨ç¬¦å·åŒºåˆ†å¼€æ¥ã€‚ä½ å¯ä»¥åœ¨ç¬¦å·è§£ææ—¶åœ¨å±€éƒ¨ç¬¦å·åå‰æ·»åŠ ç›®æ ‡åå­—ï¼ˆ`FLEObject::name`ï¼‰ä½œä¸ºå‰ç¼€ï¼Œå¹¶åœ¨é‡å®šä½æ—¶ä½¿ç”¨åŒ…å«å‰ç¼€çš„å®Œæ•´ç¬¦å·åè¿›è¡Œé‡å®šä½æŸ¥æ‰¾ã€‚è°ƒè¯•æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨å®Œæ•´çš„ç¬¦å·åæ¥å®šä½é—®é¢˜ã€‚

//TODO å±€éƒ¨ç¬¦å·ï¼Œå†…éƒ¨ç¬¦å·ï¼Œå¤–éƒ¨ç¬¦å·ï¼Œinternal linkageéƒ½æ˜¯å•¥

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½æ­£ç¡®å¤„ç†ç¬¦å·å†²çªå’Œå±€éƒ¨ç¬¦å·äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_4
```

## ä»»åŠ¡äº”ï¼šå¤„ç† 64 ä½åœ°å€

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¤„ç†çš„éƒ½æ˜¯ 32 ä½çš„åœ°å€ï¼ˆ`R_X86_64_32` å’Œ `R_X86_64_PC32`ï¼‰ã€‚ä½†åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ã€‚æ¯”å¦‚ï¼š

```c
// ä¸€ä¸ªå…¨å±€æ•°ç»„
int numbers[] = {1, 2, 3, 4};

// ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªæ•°ç»„çš„æŒ‡é’ˆ
int *ptr = &numbers[0];  // éœ€è¦å®Œæ•´çš„ 64 ä½åœ°å€ï¼
```

åœ¨é“¾æ¥æ—¶ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ `numbers` çš„åœ°å€ï¼Œå¹¶å†™å…¥æ•°æ®æ®µä½œä¸º `ptr` ç¬¦å·çš„å€¼ã€‚x86-64 ç³»ç»Ÿä¸Šï¼Œ`int *` ç±»å‹æ˜¯ 64 ä½çš„ï¼Œå› ä¸ºå…¶æŒ‡å‘çš„åœ°å€æ˜¯ 64 ä½çš„ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼š

```json5
{
    "type": ".obj",
    ".data": [
        "ğŸ“¤: numbers 16", // numbers æ•°ç»„
        "ğŸ”¢: 01 00 00 00", // 1
        "ğŸ”¢: 02 00 00 00", // 2
        "ğŸ”¢: 03 00 00 00", // 3
        "ğŸ”¢: 04 00 00 00"  // 4
    ],
    ".data.rel.local": [
        "ğŸ“¤: ptr 8",
        "â“: .abs64(numbers + 0)" // éœ€è¦ numbers çš„å®Œæ•´åœ°å€
    ]
    ...
}
```

æ³¨æ„é‚£ä¸ª `.abs64` â€”â€” è¿™æ˜¯ä¸€ä¸ªæ–°çš„é‡å®šä½ç±»å‹ï¼ˆ`R_X86_64_64`ï¼‰ï¼Œå®ƒå‘Šè¯‰é“¾æ¥å™¨ï¼šâ€œåœ¨è¿™é‡Œå¡«å…¥ç¬¦å·çš„å®Œæ•´ 64 ä½åœ°å€â€ã€‚

å¯¹åº”çš„ `Relocation` ç»“æ„ä½“å¦‚ä¸‹ï¼š

```cpp
Relocation {
    .type = RelocationType::R_X86_64_64,  // 64ä½ç»å¯¹å¯»å€
    .offset = 0,                          // é‡å®šä½ä½ç½®
    .symbol = "numbers",                  // ç›®æ ‡ç¬¦å·
    .addend = 0                          // åç§»é‡
}
```

ä½ çš„ä»»åŠ¡æ˜¯æ”¯æŒè¿™ç§é‡å®šä½ã€‚å¤„ç†è¿™ç§é‡å®šä½æ—¶ï¼Œè®¡ç®—å…¬å¼ä¸ [32 ä½ç»å¯¹å¯»å€](#é‡å®šä½) ç›¸åŒï¼Œä½†å†™å…¥æ—¶éœ€è¦å†™å…¥å®Œæ•´çš„ 8 å­—èŠ‚ã€‚

> [!TIP]
> ä½¿ç”¨ 64 ä½æ•´æ•°å­˜å‚¨åœ°å€ï¼Œå°å¿ƒæ•´æ•°æº¢å‡º

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½å¤„ç† 64 ä½åœ°å€äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_5
```

## ä»»åŠ¡å…­ï¼šåˆ†ç¦»ä»£ç å’Œæ•°æ®

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ç¨‹åºçš„æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ªæ®µä¸­ã€‚è¿™çœ‹èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†æ­£å¦‚æˆ‘ä»¬åœ¨ Attack Homework ä¸­æ‰€å­¦åˆ°çš„é‚£æ ·ï¼Œè¿™ç»™äº†æ”»å‡»è€…ç¯¡æ”¹ä»£ç çš„æœºä¼šã€‚æ¯”å¦‚ï¼š

```c
void hack() {
    // 1. ä¿®æ”¹ä»£ç 
    void* code = (void*)hack;
    *(char*)code = 0x90;     // å¦‚æœä»£ç æ®µå¯å†™ï¼Œç¨‹åºå¯ä»¥è¢«ç¯¡æ”¹ï¼

    // 2. æ‰§è¡Œæ•°æ®
    char shellcode[] = {...}; // ä¸€äº›æ¶æ„ä»£ç 
    ((void(*)())shellcode)(); // å¦‚æœæ•°æ®æ®µå¯æ‰§è¡Œï¼Œè¿™å°±æ˜¯æ¼æ´ï¼
}
```

ä¸ºäº†é˜²æ­¢è¿™äº›æ”»å‡»ï¼Œç°ä»£ç³»ç»Ÿé‡‡ç”¨å†…å­˜åˆ†æ®µä¿æŠ¤æœºåˆ¶ã€‚åœ¨ FLE æ ¼å¼ä¸­ï¼Œæˆ‘ä»¬çš„ç¼–è¯‘å™¨å·²ç»å°†ä»£ç åˆ’åˆ†ä¸ºäº†ä¸åŒçš„èŠ‚ï¼š

```json5
{
  "type": ".obj",
  // è¿™é‡Œçš„èŠ‚å¤´å‘¢ï¼Ÿ
  ".text": [
    "ğŸ“¤: main 40 0",
    "ğŸ”¢: f3 0f 1e fa 55 48 89 e5 be 00 00 00 00 48 8d 05",
    "â“: .rel(.rodata - 4)",
    "ğŸ”¢: 48 89 c7 b8 00 00 00 00 e8",
    "â“: .rel(print - 4)",
    "ğŸ”¢: b8 00 00 00 00 5d c3"
  ],
  ".data": [
    "ğŸ“¤: counter 4 0",
    "ğŸ”¢: 03 00 00 00" // å·²åˆå§‹åŒ–æ•°æ®
  ],
  ".bss": [
    "ğŸ“¤: buffer 4096 0" // æœªåˆå§‹åŒ–æ•°æ®ï¼Œåªè®°å½•å¤§å°
  ],
  ".rodata": [
    "ğŸ·ï¸: .rodata 0 0",
    "ğŸ”¢: 48 65 6c 6c 6f 00" // "Hello"
  ]
}
```

èŠ‚å¤´ï¼ˆsection headersï¼‰æ˜¯ç›®æ ‡æ–‡ä»¶ä¸­çš„é‡è¦å…ƒæ•°æ®ï¼Œå®ƒæè¿°äº†æ¯ä¸ªèŠ‚çš„å±æ€§å’Œä½ç½®ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬çš„ FLE æ ¼å¼ä¸­ï¼Œæ¯ä¸ªèŠ‚å¤´åŒ…å«ï¼š

- `name`ï¼šèŠ‚çš„åç§°ï¼ˆå¦‚ `.text`ã€`.data` ç­‰ï¼‰
- `type`ï¼šèŠ‚çš„ç±»å‹ï¼ˆå¦‚ä»£ç ã€æ•°æ®ç­‰ï¼‰
- `flags`ï¼šèŠ‚çš„å±æ€§æ ‡å¿—
- `addr`ï¼šèŠ‚åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
- `offset`ï¼šèŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡
- `size`ï¼šèŠ‚çš„å¤§å°

è¿™äº›ä¿¡æ¯å¯¹é“¾æ¥å™¨æ¥è¯´éå¸¸é‡è¦ â€”â€” å®ƒä»¬æè¿°äº†ç›®æ ‡æ–‡ä»¶ä¸­å„ä¸ªèŠ‚çš„ç»„ç»‡æ–¹å¼ã€‚é“¾æ¥å™¨éœ€è¦ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥å®šä½å’Œè¯»å–å„ä¸ªèŠ‚çš„å†…å®¹ï¼Œåˆå¹¶æ¥è‡ªä¸åŒæ–‡ä»¶çš„åŒç±»å‹èŠ‚ï¼Œå¹¶åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ç¡®å®šæœ€ç»ˆçš„å†…å­˜å¸ƒå±€ã€‚

> [!NOTE]
> Linux çš„æ ‡å‡† ELF æ ¼å¼ä¸­å­˜åœ¨ä¸¤ç§é‡è¦çš„è§†å›¾:
>
> - **é“¾æ¥è§†å›¾ï¼ˆLinking Viewï¼‰** ç”±èŠ‚å¤´ï¼ˆSection Headersï¼‰è¡¨æè¿°ï¼ŒåŒ…å«é“¾æ¥æ—¶éœ€è¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ `.text`ã€`.data`ã€`.bss` ç­‰èŠ‚ã€‚è¿™äº›ä¿¡æ¯ä¸»è¦ç”¨äºé“¾æ¥å’Œè°ƒè¯•ï¼Œåœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¹¶éå¿…éœ€ã€‚
> - **è¿è¡Œè§†å›¾ï¼ˆExecution Viewï¼‰** ç”±ç¨‹åºå¤´ï¼ˆProgram Headersï¼‰è¡¨æè¿°ï¼Œå®šä¹‰äº†ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜æ®µï¼ˆsegmentï¼‰ã€‚å®ƒæè¿°å¦‚ä½•å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œæ˜¯åŠ è½½ç¨‹åºï¼ˆloaderï¼‰å¿…éœ€çš„ä¿¡æ¯ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸å¯æˆ–ç¼ºã€‚
>
> åœ¨æ ‡å‡†çš„ELFä¸­ï¼Œä¸€ä¸ªå†…å­˜æ®µé€šå¸¸ä¼šåŒ…å«å¤šä¸ªå…·æœ‰ç›¸åŒæƒé™éœ€æ±‚çš„èŠ‚ã€‚ä¾‹å¦‚ï¼Œå¯è¯»å†™çš„æ•°æ®æ®µé€šå¸¸åŒæ—¶åŒ…å« `.data` å’Œ `.bss` èŠ‚ï¼Œå®ƒä»¬ä¼šè¢«æ˜ å°„åˆ°åŒä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸä¸­ã€‚è¿™ç§è®¾è®¡å¯ä»¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œç®€åŒ–ç¨‹åºçš„åŠ è½½è¿‡ç¨‹ã€‚

> [!TIP]
> ä½†ä¸ºæ–¹ä¾¿èµ·è§ï¼Œä½ å¯ä»¥å§‹ç»ˆä¿æŒèŠ‚å’Œæ®µçš„ä¸€å¯¹ä¸€æ˜ å°„ï¼Œå°†æ¯ä¸ªèŠ‚éƒ½å•ç‹¬æ˜ å°„ä¸ºä¸€ä¸ªå†…å­˜æ®µã€‚

è¿™äº›èŠ‚éœ€è¦è¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå…·ä½“ç±»å‹åŠå«ä¹‰å¦‚ä¸‹ï¼š

| èŠ‚ | ä½œç”¨ | æƒé™
| ---- | ---- | ---- |
| `.text` èŠ‚ | å­˜æ”¾ç¨‹åºä»£ç  | r-x ï¼ˆè¯»ã€æ‰§è¡Œï¼‰|
| `.rodata` èŠ‚ | å­˜æ”¾å¸¸é‡æ•°æ® | r--ï¼ˆåªè¯»ï¼‰|
| `.data` èŠ‚ | å­˜æ”¾å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ | rw-ï¼ˆè¯»/å†™ï¼‰|
| `.bss` èŠ‚ | å­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ | rw-ï¼ˆè¯»/å†™ï¼‰|

ä½ çš„ä»»åŠ¡æ˜¯æ”¯æŒèŠ‚çš„å†…å­˜æ˜ å°„ï¼Œåœ¨ç¨‹åºå¤´ä¸­ä¸ºæ¯ä¸ªèŠ‚è®¾ç½®ç›¸åº”çš„æƒé™çº§åˆ«ï¼Œå¹¶ä¿è¯æ¯ä¸ªèŠ‚çš„èµ·å§‹åœ°å€ä¸º 4KB å¯¹é½ã€‚æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥åˆç†å®‰æ’èŠ‚çš„é¡ºåºä»¥å‡å°‘å†…å­˜ç¢ç‰‡ã€‚

> [!TIP]
> è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ enum æ¥è¡¨ç¤ºã€‚

> [!IMPORTANT]
> `.bss` èŠ‚ç›¸å¯¹ç‰¹æ®Šã€‚ç”±äºå®ƒä¸“é—¨ç”¨äºå­˜æ”¾é›¶åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ˆå…¨å±€å˜é‡çš„é»˜è®¤åˆå§‹åŒ–å³ä¸ºé›¶åˆå§‹åŒ–ï¼‰ï¼Œä¸ºèŠ‚çœç©ºé—´ï¼Œç›®æ ‡æ–‡ä»¶åªåœ¨èŠ‚å¤´ï¼ˆ`shdrs`ï¼‰è®°å½•äº†è¿™ç‰‡ç©ºé—´çš„å¤§å°ï¼Œè€Œä¸ä¼šå®é™…å­˜å‚¨ä¸€å † `0`ã€‚
>
> åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå‡ºäºç›¸åŒåŸå› ï¼Œ`.bss` æ®µçš„ä¸€å † `0` ä¾ç„¶ä¸åº”è¯¥è¢«å®é™…å­˜å‚¨ã€‚
>
> åŠ è½½å™¨ä¼šè‡ªåŠ¨å°† `.bss` æ®µæ˜ å°„ä¸ºä¸€å—åˆå§‹åŒ–ä¸º `0` çš„å¯¹åº”çš„å†…å­˜åŒºåŸŸã€‚
>
// TODO: é‚£æ€ä¹ˆåˆå¹¶ï¼Ÿï¼Ÿ

å®Œæˆåï¼Œä½ çš„é“¾æ¥å™¨å°±èƒ½ç”Ÿæˆå…·æœ‰æ­£ç¡®å†…å­˜å¸ƒå±€å’Œè®¿é—®æƒé™çš„å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚è¿è¡Œæµ‹è¯•æ¥éªŒè¯ï¼š

```bash
make test_6
```

## ä»»åŠ¡ä¸ƒï¼šéªŒè¯ä¸æ€»ç»“

æ­å–œä½ å®Œæˆäº†æ‰€æœ‰åŸºç¡€ä»»åŠ¡ï¼ç°åœ¨è®©æˆ‘ä»¬éªŒè¯æ•´ä¸ªé“¾æ¥å™¨çš„åŠŸèƒ½ã€‚

### å®Œæ•´æµ‹è¯•

```bash
make test
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

```
Preparing FLE Tools...
âœ“ FLE Tools compiled successfully
Preparing minilibc...
âœ“ minilibc compiled successfully

Running 12 test cases...

âœ“ nm Tool Test [2/2]: Passed
âœ“ Single File Test [3/3]: Passed
âœ“ Absolute Addressing Test [3/3]: Passed
âœ“ Absolute + Relative Addressing Test [4/4]: Passed
âœ“ Position Independent Executable Test [5/5]: Passed
âœ“ Strong Symbol Conflict Test [3/3]: Passed
âœ“ Weak Symbol Override Test [4/4]: Passed
âœ“ Multiple Weak Symbol Warning [5/5]: Passed
âœ“ Local Symbol Access Test [7/7]: Passed
âœ“ 64-bit Absolute Relocation Test [3/3]: Passed
âœ“ BSS Section Linking Test [5/5]: Passed
âœ“ Section Permission Control Test [10/10]: Passed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Test Case                           â”ƒ Result â”ƒ  Time â”ƒ     Score â”ƒ Message             â”ƒ
â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ nm Tool Test                        â”‚  PASS  â”‚ 0.36s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Single File Test                    â”‚  PASS  â”‚ 0.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute Addressing Test            â”‚  PASS  â”‚ 0.29s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Absolute + Relative Addressing Test â”‚  PASS  â”‚ 0.60s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Position Independent Executable     â”‚  PASS  â”‚ 0.93s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Test                                â”‚        â”‚       â”‚           â”‚                     â”‚
â”‚ Strong Symbol Conflict Test         â”‚  PASS  â”‚ 0.70s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Weak Symbol Override Test           â”‚  PASS  â”‚ 0.78s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Multiple Weak Symbol Warning        â”‚  PASS  â”‚ 0.85s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Local Symbol Access Test            â”‚  PASS  â”‚ 0.46s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ 64-bit Absolute Relocation Test     â”‚  PASS  â”‚ 0.37s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ BSS Section Linking Test            â”‚  PASS  â”‚ 0.77s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â”‚ Section Permission Control Test     â”‚  PASS  â”‚ 1.27s â”‚ 10.0/10.0 â”‚ All steps completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Total Score: 120.0/120.0 (100.0%)                                                      â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

```

### å®éªŒæŠ¥å‘Šè¦æ±‚

è¯·å‚è€ƒ[æŠ¥å‘Šæ¨¡æ¿é€šç”¨æŒ‡å—](./report/README.md)ï¼ŒåŸºäº[å®éªŒæŠ¥å‘Šæ¨¡æ¿](./report/report.md)ï¼Œå®Œæˆå®éªŒæŠ¥å‘Šã€‚

## å®Œæˆæœ¬å®éªŒ

### æäº¤

æˆ‘ä»¬ä½¿ç”¨ GitHub Classroom è¿›è¡Œæäº¤ï¼š

1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤åˆ°ä½ çš„ä»“åº“
2. GitHub Actions ä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•
3. æˆ‘ä»¬å°†ä»¥ Actions çš„è¾“å‡ºä½œä¸ºè¯„åˆ†ä¾æ®

### è¯„åˆ†æ ‡å‡†

åˆ†æ•°ç”±**æ­£ç¡®æ€§å¾—åˆ†**å’Œ**ä»£ç è´¨é‡å¾—åˆ†**ä¸¤éƒ¨åˆ†ç»„æˆï¼Œæ­£ç¡®æ€§å¾—åˆ†å  60%ï¼Œä»£ç è´¨é‡å¾—åˆ†å  40%ï¼Œå³ï¼š

$$
\text{æ€»åˆ†} = \frac{\text{æ­£ç¡®æ€§å¾—åˆ†}} {\text{æ­£ç¡®æ€§æ»¡åˆ†}} \times 60\% + \text{ä»£ç è´¨é‡å¾—åˆ†} \times 40\%
$$

å…¶ä¸­ï¼Œæ­£ç¡®æ€§å¾—åˆ†ç”± GitHub Classroom è‡ªåŠ¨è®¡ç®—ï¼Œä»£ç è´¨é‡å¾—åˆ†ç”±åŠ©æ•™æ ¹æ®ä»£ç é£æ ¼å’Œå®éªŒæŠ¥å‘Šè¯„åˆ†ï¼Œå…·ä½“è¡¡é‡å› ç´ ä¸ºï¼š

- ä»£ç é£æ ¼
  - ä»£ç è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œé€»è¾‘æ¸…æ™°ï¼Œä»£ç ç®€æ´ï¼Œä»…åœ¨å¿…è¦æ—¶æ·»åŠ æ³¨é‡Š
  - ç§¯æä½¿ç”¨ C++ æ ‡å‡†åº“ï¼Œä¸é‡å¤é€ è½®å­
  - é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œè¿›è¡Œå¤šå±‚æ¬¡çš„é”™è¯¯æ£€æŸ¥
- å®éªŒæŠ¥å‘Š
  - å®éªŒæŠ¥å‘Šå†…å®¹å®Œæ•´ã€æ ¼å¼è§„èŒƒã€ç»“æ„æ¸…æ™°
  - å®éªŒæŠ¥å‘Šå†…å®¹ä¸ä»£ç ä¸€è‡´ï¼Œæ— æ˜æ˜¾çŸ›ç›¾ï¼Œä½“ç°å‡ºå¯¹å®éªŒè€ƒå¯ŸçŸ¥è¯†çš„åŸºæœ¬äº†è§£
  - æœ‰æ€è€ƒï¼Œæœ‰æ€»ç»“ï¼Œæœ‰åæ€ï¼Œæœ‰åˆ›æ–°
  - å¯¹å®éªŒæä¾›æœ‰ä»·å€¼çš„åé¦ˆå’Œå»ºè®®ï¼Œç§¯æå‚ä¸å¼€æºåä½œ

## è°ƒè¯•å»ºè®®

1. ä»”ç»†é˜…è¯» `include/fle.hpp` ä¸­çš„æ•°æ®ç»“æ„å®šä¹‰
2. ä½¿ç”¨ `readfle` å·¥å…·æŸ¥çœ‹ FLE æ–‡ä»¶çš„å†…å®¹
3. æµ‹è¯•ç”¨ä¾‹æä¾›äº†å¾ˆå¥½çš„å‚è€ƒå®ä¾‹
4. é“¾æ¥å™¨çš„è°ƒè¯•æŠ€å·§ï¼š
   - ä½¿ç”¨ `objdump` æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
   - æ‰“å°ä¸­é—´è¿‡ç¨‹çš„é‡è¦ä¿¡æ¯
   - åˆ†æ­¥éª¤å®ç°ï¼Œå…ˆç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£ç¡®

### æ‰‹åŠ¨æµ‹è¯•
æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç›®å½•ä¸‹éƒ½æœ‰ `config.toml` æ–‡ä»¶æè¿°äº†æµ‹è¯•çš„æ‰§è¡Œæ­¥éª¤ã€‚å½“ä½ è¿è¡Œ `make test` æˆ– `make test_<n>`ï¼Œå‘ç°æŸä¸ªæµ‹è¯•ç‚¹æœªé€šè¿‡æ—¶ï¼Œä½ å¯ä»¥ï¼š
1. è¿è¡Œä½ çš„é“¾æ¥å™¨ï¼š`./ld ${TEST_BUILD}/a.fle ${TEST_BUILD}/b.fle -o ${TEST_BUILD}/out.fle`
2. ä½¿ç”¨ `readfle` å’Œ `disasm` æ£€æŸ¥è¾“å‡ºæ–‡ä»¶ï¼š`./readfle ${TEST_BUILD}/out.fle` å’Œ `./disasm ${TEST_BUILD}/out.fle <section>`

è¿™é‡Œï¼Œ`TEST_BUILD` æ˜¯æµ‹è¯•è„šæœ¬è‡ªåŠ¨è®¾ç½®çš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡è¿è¡Œçš„æµ‹è¯•è·¯å¾„ã€‚

// ç°åœ¨make testæœ‰å¹¶è¡Œå— è¿˜æ˜¯ä¸€ä¸ªä¸ªæ¥ï¼Ÿ

è¿™æ ·å¯ä»¥æ›´æ–¹ä¾¿åœ°è°ƒè¯•å•ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚å¦‚æœéœ€è¦å®Œæ•´çš„æµ‹è¯•æµç¨‹ï¼Œå¯ä»¥å‚è€ƒå¯¹åº”æµ‹è¯•ç›®å½•ä¸‹çš„ `config.toml` æ–‡ä»¶ã€‚
//TODO

## è¿›é˜¶å†…å®¹

å®Œæˆäº†åŸºæœ¬ä»»åŠ¡åï¼Œä½ å¯ä»¥å°è¯•ï¼š

1. æ”¯æŒæ›´å¤šçš„é‡å®šä½ç±»å‹
2. å®ç°å…±äº«åº“åŠ è½½
3. æ·»åŠ ç¬¦å·ç‰ˆæœ¬æ§åˆ¶
4. ä¼˜åŒ–é“¾æ¥æ€§èƒ½
5. æ”¯æŒå¢é‡é“¾æ¥

// TODO

è¿™äº›å†…å®¹ä¸ä¼šè®¡å…¥æœ¬æ¬¡å®éªŒçš„è¯„åˆ†ï¼Œä¹‹åçš„ä»»åŠ¡ä»¥åå†æ¥æ¢ç´¢å§ï½

## Acknowledgements

æœ¬å®éªŒç”±22çº§å›¾çµç­çš„æçŸ¥éã€å½­æ–‡åšæå‡ºå¹¶è®¾è®¡ã€‚

21çº§å›¾çµç­çš„æ½˜ä¿Šè¾¾ä¸ºå®éªŒæ–‡æ¡£æä¾›äº†å®è´µçš„å»ºè®®ã€‚

æ„Ÿè°¢æŸ´äº‘é¹è€å¸ˆã€ç‹æ™¶è€å¸ˆå¯¹æœ¬å®éªŒçš„æ”¯æŒï¼

## å‚è€ƒèµ„æ–™

1. [I Executable and Linkable Format (ELF)](https://www.cs.cmu.edu/afs/cs/academic/class/15213-f00/docs/elf.pdf)
2. [CSAPP: Computer Systems A Programmer's Perspective](https://csapp.cs.cmu.edu/)
3. [System V ABI](https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf)
4. [Linkers & Loaders](https://linker.iecc.com/)
5. [How To Write Shared Libraries](https://www.akkadia.org/drepper/dsohowto.pdf)
